<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <Choose>
        <When Condition="$([MSBuild]::IsTargetFrameworkCompatible('net461', '$(TargetFramework)'))">
            <PropertyGroup>
                <_IkvmImageTargetFramework>net461</_IkvmImageTargetFramework>
            </PropertyGroup>
        </When>
        <When Condition="$([MSBuild]::IsTargetFrameworkCompatible('netcoreapp3.1', '$(TargetFramework)'))">
            <PropertyGroup>
                <_IkvmImageTargetFramework>netcoreapp3.1</_IkvmImageTargetFramework>
            </PropertyGroup>
        </When>
    </Choose>

    <Choose>
        <When Condition="$(RuntimeIdentifier.StartsWith('win'))">
            <Choose>
                <When Condition="$(RuntimeIdentifier.EndsWith('-x64'))">
                    <PropertyGroup>
                        <_IkvmImageRuntimeIdentifier>win7-x64</_IkvmImageRuntimeIdentifier>
                    </PropertyGroup>
                </When>
                <When Condition="$(RuntimeIdentifier.EndsWith('-x86'))">
                    <PropertyGroup>
                        <_IkvmImageRuntimeIdentifier>win7-x86</_IkvmImageRuntimeIdentifier>
                    </PropertyGroup>
                </When>
            </Choose>
        </When>
        <When Condition="$(RuntimeIdentifier.StartsWith('linux'))">
            <Choose>
                <When Condition="$(RuntimeIdentifier.EndsWith('-x64'))">
                    <PropertyGroup>
                        <_IkvmImageRuntimeIdentifier>linux-x64</_IkvmImageRuntimeIdentifier>
                    </PropertyGroup>
                </When>
            </Choose>
        </When>
    </Choose>

    <!-- Adds an index value to each item. Can be used to ensure at least one unique metadata value is available on each item. -->
    <UsingTask TaskName="_IkvmImageItemDistinct" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" Output="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                var hs = new HashSet<string>();
                var ls = new List<ITaskItem>();
                foreach (var item in Items)
                    if (hs.Add(item.GetMetadata("TargetPath")))
                        ls.Add(item);
                        
                Items = ls.ToArray();
                ]]>
            </Code>
        </Task>
    </UsingTask>

    <ItemGroup>
        <IkvmImageRuntimeIdentifiers Include="win7-x64" />
        <IkvmImageRuntimeIdentifiers Include="win7-x86" />
        <IkvmImageRuntimeIdentifiers Include="linux-x64" />
    </ItemGroup>

    <Target Name="GetIkvmImageItemsForRuntimeIdentifier" Outputs="%(IkvmImageRuntimeIdentifiers.Identity)">
        <PropertyGroup>
            <_IkvmImageRuntimeIdentifiers>%(IkvmImageRuntimeIdentifiers.Identity)</_IkvmImageRuntimeIdentifiers>
        </PropertyGroup>

        <ItemGroup>
            <_IkvmImageContentWithTargetPath Include="@(IkvmImageItem)" Condition=" '%(IkvmImageItem.TargetFramework)' == 'any' And '%(IkvmImageItem.RuntimeIdentifier)' == 'any' ">
                <TargetFramework>$(_IkvmImageTargetFramework)</TargetFramework>
                <RuntimeIdentifier>$(_IkvmImageRuntimeIdentifiers)</RuntimeIdentifier>
            </_IkvmImageContentWithTargetPath>
            <_IkvmImageContentWithTargetPath Include="@(IkvmImageItem)" Condition=" '%(IkvmImageItem.TargetFramework)' == '$(_IkvmImageTargetFramework)' And '%(IkvmImageItem.RuntimeIdentifier)' == 'any' ">
                <TargetFramework>$(_IkvmImageTargetFramework)</TargetFramework>
                <RuntimeIdentifier>$(_IkvmImageRuntimeIdentifiers)</RuntimeIdentifier>
            </_IkvmImageContentWithTargetPath>
            <_IkvmImageContentWithTargetPath Include="@(IkvmImageItem)" Condition=" '%(IkvmImageItem.TargetFramework)' == '$(_IkvmImageTargetFramework)' And '%(IkvmImageItem.RuntimeIdentifier)' == '$(_IkvmImageRuntimeIdentifiers)' ">
                <TargetFramework>$(_IkvmImageTargetFramework)</TargetFramework>
                <RuntimeIdentifier>$(_IkvmImageRuntimeIdentifiers)</RuntimeIdentifier>
            </_IkvmImageContentWithTargetPath>
        </ItemGroup>
    </Target>

    <Target Name="GetIkvmImageItems" DependsOnTargets="GetIkvmImageItemsForRuntimeIdentifier" BeforeTargets="AssignLinkMetadata;AssignTargetPaths">
        <_IkvmImageItemDistinct Items="@(_IkvmImageContentWithTargetPath)">
            <Output TaskParameter="Items" ItemName="__IkvmImageContentWithTargetPath" />
        </_IkvmImageItemDistinct>

        <ItemGroup>
            <None Include="@(__IkvmImageContentWithTargetPath)" RemoveMetadata="RuntimeIdentifier;TargetFramework">
                <Pack>false</Pack>
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
                <CopyToPublishDirectory>Never</CopyToPublishDirectory>
                <CopyToPublishDirectory Condition=" '$(_IkvmImageRuntimeIdentifier)' == '%(__IkvmImageContentWithTargetPath.RuntimeIdentifier)' ">PreserveNewest</CopyToPublishDirectory>
                <TargetPath>ikvm\%(__IkvmImageContentWithTargetPath.RuntimeIdentifier)\%(__IkvmImageContentWithTargetPath.TargetPath)</TargetPath>
                <DestinationSubDirectory>$([System.IO.Path]::GetDirectoryName('ikvm\%(__IkvmImageContentWithTargetPath.RuntimeIdentifier)\%(__IkvmImageContentWithTargetPath.TargetPath)'))</DestinationSubDirectory>
                <Private>true</Private>
                <Link>ikvm\%(__IkvmImageContentWithTargetPath.RuntimeIdentifier)\%(__IkvmImageContentWithTargetPath.TargetPath)</Link>
            </None>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <AssignTargetPathsDependsOn>
            GetIkvmImageItemsForRuntimeIdentifier;
            GetIkvmImageItems;
            $(AssignTargetPathsDependsOn);
        </AssignTargetPathsDependsOn>
    </PropertyGroup>

</Project>
