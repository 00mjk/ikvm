<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <UseIkvmTasks Condition=" '$(UseIkvmTasks)' == '' ">true</UseIkvmTasks>
        <IkvmStageDir Condition=" '$(IkvmStageDir)' == '' ">$(IntermediateOutputPath)ikvm\stage\1\</IkvmStageDir>
        <IkvmCacheDir Condition=" '$(IkvmCacheDir)' == '' ">$([System.IO.Path]::GetTempPath())ikvm\cache\1\</IkvmCacheDir>
    </PropertyGroup>

    <!-- Transforms the IkvmReference item group into IkvmReferenceItem items. -->
    <Target Name="GetIkvmReferenceItemsFromIkvmReferences">
        <ItemGroup>
            <IkvmReferenceItem Include="@(IkvmReference)">

            </IkvmReferenceItem>
        </ItemGroup>
    </Target>

    <!-- Populates the IkvmReferenceItem set with required metadata. -->
    <Target Name="_UpdateIkvmReferenceItemsMetadata" DependsOnTargets="GetIkvmReferenceItemsFromIkvmReferences;ResolveIkvmRuntimeAssembly;ResolveIkvmRuntimeJNIAssembly;ResolveIkvmBaseAssembly;ResolveIkvmFrameworkReferences" Condition=" '@(IkvmReferenceItem)' != '' ">
        <Error Text="_UpdateIkvmReferenceItemsMetadata has no implementation." />
    </Target>

    <PropertyGroup>
        <GetIkvmReferenceItemsDependsOn>
            $(GetIkvmReferenceItemsDependsOn);
            ResolveIkvmFrameworkReferences;
            GetIkvmReferenceItemsFromIkvmReferences;
            _UpdateIkvmReferenceItemsMetadata;
        </GetIkvmReferenceItemsDependsOn>
    </PropertyGroup>

    <!-- Assembles the set of IkvmReferenceItems from various sources. -->
    <Target Name="GetIkvmReferenceItems" DependsOnTargets="$(GetIkvmReferenceItemsDependsOn)" Returns="@(IkvmReferenceItem)">

    </Target>

    <!-- Expands the IkvmReferenceItem set by the Compile metadata for inputs and outputs of the build target. -->
    <Target Name="_GetIkvmReferenceItemsCompileToCachePath" DependsOnTargets="GetIkvmReferenceItems" Condition=" '@(IkvmReferenceItem)' != '' ">
        <ItemGroup>
            <_IkvmReferenceItemCompileToCachePath Remove="@(_IkvmReferenceItemCompileToCachePath)" />
            <_IkvmReferenceItemCompileToCachePath Include="@(IkvmReferenceItem->'%(Compile)')" Condition=" '%(IkvmReferenceItem.Compile)' != '' ">
                <CachePath>%(IkvmReferenceItem.CachePath)</CachePath>
            </_IkvmReferenceItemCompileToCachePath>
        </ItemGroup>
    </Target>

    <!-- Builds the IkvmReferenceItem set into their output items within the cache. -->
    <Target Name="_CompileIkvmReferences" DependsOnTargets="ResolveIkvmRuntimeAssembly;ResolveIkvmRuntimeJNIAssembly;ResolveIkvmBaseAssembly;ResolveIkvmReferenceAssemblies;_GetIkvmReferenceItemsCompileToCachePath" Inputs="@(_IkvmReferenceItemCompileToCachePath)" Outputs="%(_IkvmReferenceItemCompileToCachePath.CachePath)" Condition=" '@(_IkvmReferenceItemCompileToCachePath.CachePath)' != '' ">
        <Error Text="_CompileIkvmReferences has no implementation." />
    </Target>

    <PropertyGroup>
        <CompileIkvmReferencesDependsOn>
            $(CompileIkvmReferenceAssemblies);
            GetIkvmReferenceItems;
            ResolveIkvmFrameworkReferences;
            _GetIkvmReferenceItemsCompileToCachePath;
            _CompileIkvmReferences;
        </CompileIkvmReferencesDependsOn>
    </PropertyGroup>

    <Target Name="CompileIkvmReferences" DependsOnTargets="$(CompileIkvmReferencesDependsOn)">

    </Target>

    <!-- Ensure the IkvmReference assemblies are built before compile. -->
    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <CompileDependsOn>
            CompileIkvmReferences;
            $(CompileDependsOn);
        </CompileDependsOn>
    </PropertyGroup>

    <!-- Adds the expected IkvmReferences to the Reference set. -->
    <Target Name="_ResolveIkvmReferences" DependsOnTargets="GetIkvmReferenceItems">
        <ItemGroup>
            <Reference Include="@(IkvmReferenceItem->'%(AssemblyName), Version=%(AssemblyVersion)')">
                <ReferenceSourceTarget>ResolveIkvmReferences</ReferenceSourceTarget>
                <HintPath>%(IkvmReferenceItem.CachePath)</HintPath>
                <Aliases>%(IkvmReferenceItem.Aliases)</Aliases>
                <Private>%(IkvmReferenceItem.Private)</Private>
                <ReferenceOutputAssembly>%(IkvmReferenceItem.ReferenceOutputAssembly)</ReferenceOutputAssembly>
                <JavaClasspath>%(IkvmReferenceItem.Compile)</JavaClasspath>
            </Reference>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <ResolveIkvmReferencesDependsOn>
            $(ResolveIkvmReferencesDependsOn);
            CompileIkvmReferences;
            GetIkvmReferenceItems;
            _ResolveIkvmReferences;
        </ResolveIkvmReferencesDependsOn>
    </PropertyGroup>

    <Target Name="ResolveIkvmReferences" DependsOnTargets="$(ResolveIkvmReferencesDependsOn)">

    </Target>

    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <ResolveAssemblyReferencesDependsOn>
            ResolveIkvmReferences;
            $(ResolveAssemblyReferencesDependsOn);
        </ResolveAssemblyReferencesDependsOn>
    </PropertyGroup>

    <!-- Include Task or NoTask implementation of targets. -->
    <Import Project="IKVM.Tasks.targets" Condition=" '$(UseIkvmTasks)' == 'true' "/>
    <Import Project="IKVM.NoTasks.targets" Condition=" '$(UseIkvmTasks)' != 'true' "/>
</Project>
