<Project>

    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <IkvmToolFramework Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'netstandard1.0'))">netcoreapp3.1</IkvmToolFramework>
        <IkvmToolFramework Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net461'))">net461</IkvmToolFramework>
        <IkvmToolFramework Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'netcoreapp3.1'))">netcoreapp3.1</IkvmToolFramework>
        <IkvmToolFolder>$(IkvmToolFramework)</IkvmToolFolder>
        <IkvmToolPath>$([System.IO.Path]::GetFullPath('$(IkvmDir)tools\$(IkvmToolFolder)\'))</IkvmToolPath>
        <IkvmUseDotNetExec>false</IkvmUseDotNetExec>
        <IkvmUseDotNetExec Condition=" '$(IkvmToolFramework)' == 'netcoreapp3.1' ">true</IkvmUseDotNetExec>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(IkvmToolFramework)' == 'net461' ">
        <IkvmTool>$(IkvmToolPath)ikvm.exe</IkvmTool>
        <IkvmcTool>$(IkvmToolPath)ikvmc.exe</IkvmcTool>
        <IkvmstubTool>$(IkvmToolPath)ikvmstub.exe</IkvmstubTool>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(IkvmToolFramework)' == 'netcoreapp3.1' ">
        <IkvmTool>$(IkvmToolPath)ikvm.dll</IkvmTool>
        <IkvmcTool>$(IkvmToolPath)ikvmc.dll</IkvmcTool>
        <IkvmcToolNoStdLib>true</IkvmcToolNoStdLib>
        <IkvmstubTool>$(IkvmToolPath)ikvmstub.dll</IkvmstubTool>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <IkvmStageDir Condition=" '$(IkvmStageDir)' == '' ">$(IntermediateOutputPath)ikvm\</IkvmStageDir>
        <IkvmCacheDir Condition=" '$(IkvmCacheDir)' == '' ">$([System.IO.Path]::GetTempPath())ikvm\cache\1\</IkvmCacheDir>
    </PropertyGroup>

    <!-- Gathers those references which are either related to the Framework itself, or IKVM. -->
    <Target Name="GetIkvmFrameworkReferences" DependsOnTargets="ResolveAssemblyReferences">
        <ItemGroup>
            <IkvmFrameworkReference Include="@(ReferencePath)" Condition=" '%(ReferencePath.FrameworkReferenceName)' != '' Or '$(FrameworkFile)' == 'true' " />
            <IkvmRuntimeAssembly Include="@(ReferencePath)" Condition=" '%(ReferencePath.NuGetPackageId)' == 'IKVM' And '%(Filename)%(Extension)' == 'IKVM.Runtime.dll' " />
        </ItemGroup>
    </Target>

    <!-- Transforms the IkvmReference item group into IkvmReferenceItem items. -->
    <Target Name="GetIkvmReferenceItemsFromIkvmReferences">
        <ItemGroup>
            <IkvmReferenceItem Include="@(IkvmReference)">

            </IkvmReferenceItem>
        </ItemGroup>
    </Target>

    <!-- Populates the IkvmReferenceItem set with required metadata. -->
    <Target Name="GetIkvmReferenceItemsMetadata" DependsOnTargets="GetIkvmReferenceItemsFromIkvmReferences;GetIkvmFrameworkReferences" Condition=" '@(IkvmReferenceItem)' != '' ">
        <!-- Probes for default metadata from the reference item. -->
        <IkvmReferenceItemAssignMetadata Items="@(IkvmReferenceItem)">
            <Output TaskParameter="Items" ItemName="_IkvmReferenceItemWithMetadata" />
        </IkvmReferenceItemAssignMetadata>

        <!-- Validates the metadata before continuing. -->
        <IkvmReferenceItemValidate Items="@(_IkvmReferenceItemWithMetadata)" >

        </IkvmReferenceItemValidate>

        <!-- Configures the identity value to uniquely identify a reference. -->
        <IkvmReferenceItemAssignIdentity Items="@(_IkvmReferenceItemWithMetadata)" ToolVersion="$(IkvmVersion)" ToolFramework="$(IkvmToolFramework)" RuntimeAssembly="@(IkvmRuntimeAssembly)" References="@(IkvmFrameworkReference)" >
            <Output TaskParameter="Items" ItemName="_IkvmReferenceItemWithIdentity" />
        </IkvmReferenceItemAssignIdentity>

        <!-- Assign newly discovered items. -->
        <ItemGroup>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)"/>
            <IkvmReferenceItem Include="@(_IkvmReferenceItemWithIdentity)" />
        </ItemGroup>

    </Target>

    <!-- Duplicate set for reference lookup in batched target. -->
    <Target Name="GetIkvmReferenceItemsForLookup" DependsOnTargets="GetIkvmReferenceItemsMetadata" Condition=" '@(IkvmReferenceItem)' != '' ">
        <ItemGroup>
            <_IkvmReferenceItemForLookup Include="@(IkvmReferenceItem)" />
        </ItemGroup>
    </Target>

    <!-- Applies the ResolvedReferences metadata to each item. -->
    <Target Name="GetIkvmReferenceItemsResolvedReferencesForItem" DependsOnTargets="GetIkvmReferenceItemsForLookup" Outputs="%(IkvmReferenceItem.Identity).batch">
        <PropertyGroup>
            <_References>;%(IkvmReferenceItem.References);</_References>
        </PropertyGroup>
        <ItemGroup>
            <_ResolvedReferences Include="@(_IkvmReferenceItemForLookup->'%(CachePath)')" Condition="$(_References.Contains(';%(Identity);'))" />
        </ItemGroup>
        <ItemGroup>
            <_IkvmReferenceItemForItem Include="@(IkvmReferenceItem)">
                <ResolvedReferences>@(_ResolvedReferences, ';')</ResolvedReferences>
            </_IkvmReferenceItemForItem>
        </ItemGroup>
    </Target>

    <!-- Applies the ResolvedReferences metadata to each item. -->
    <Target Name="GetIkvmReferenceItemsResolvedReferences" DependsOnTargets="GetIkvmReferenceItemsResolvedReferencesForItem" Condition=" '@(IkvmReferenceItem)' != '' ">
        <ItemGroup>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)"/>
            <IkvmReferenceItem Include="@(_IkvmReferenceItemForItem)" />
        </ItemGroup>
    </Target>

    <!-- Applies the Stage and Cache paths to the items.-->
    <Target Name="GetIkvmReferenceItemsPaths" DependsOnTargets="GetIkvmReferenceItemsResolvedReferences" Condition=" '@(IkvmReferenceItem)' != '' ">
        <ItemGroup>
            <_IkvmReferenceItemWithPaths Include="@(IkvmReferenceItem)">
                <StagePath>$(IkvmStageDir)%(IkvmIdentity)\%(AssemblyName).dll</StagePath>
                <CachePath>$(IkvmCacheDir)%(IkvmIdentity)\%(AssemblyName).dll</CachePath>
            </_IkvmReferenceItemWithPaths>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)"/>
            <IkvmReferenceItem Include="@(_IkvmReferenceItemWithPaths)" />
        </ItemGroup>
    </Target>

    <!-- Sorts the IkvmReferenceItem set. -->
    <Target Name="GetIkvmReferenceItemsSorted" DependsOnTargets="GetIkvmReferenceItemsPaths" Condition=" '@(IkvmReferenceItem)' != '' ">
        <IkvmReferenceItemSort Items="@(IkvmReferenceItem)" >
            <Output TaskParameter="Items" ItemName="_IkvmReferenceItemSorted" />
        </IkvmReferenceItemSort>
        <ItemGroup>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)" />
            <IkvmReferenceItem Include="@(_IkvmReferenceItemSorted)" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetIkvmReferenceItemsDependsOn>
            $(GetIkvmReferenceItemsDependsOn);
            GetIkvmFrameworkReferences;
            GetIkvmReferenceItemsFromIkvmReferences;
            GetIkvmReferenceItemsMetadata;
            GetIkvmReferenceItemsForLookup;
            GetIkvmReferenceItemsResolvedReferencesForItem;
            GetIkvmReferenceItemsResolvedReferences;
            GetIkvmReferenceItemsPaths;
            GetIkvmReferenceItemsSorted;
        </GetIkvmReferenceItemsDependsOn>
    </PropertyGroup>

    <!-- Assembles the set of IkvmReferenceItems from various sources. -->
    <Target Name="GetIkvmReferenceItems" DependsOnTargets="$(GetIkvmReferenceItemsDependsOn)" Returns="@(IkvmReferenceItem)">

    </Target>

    <!-- Expands the IkvmReferenceItem set by the Compile metadata for inputs and outputs of the build target. -->
    <Target Name="GetIkvmReferenceItemsCompileToCachePath" DependsOnTargets="GetIkvmReferenceItems" Condition=" '@(IkvmReferenceItem)' != '' ">
        <ItemGroup>
            <IkvmReferenceItemCompileToCachePath Include="@(IkvmReferenceItem->'%(Compile)')" Condition=" '%(IkvmReferenceItem.Compile)' != '' ">
                <CachePath>%(IkvmReferenceItem.CachePath)</CachePath>
            </IkvmReferenceItemCompileToCachePath>
        </ItemGroup>
    </Target>

    <!-- Builds the IkvmReferenceItem set into their output items within the cache. -->
    <Target Name="_CompileIkvmReferences" DependsOnTargets="GetIkvmReferenceItemsCompileToCachePath;GetIkvmFrameworkReferences" Inputs="@(IkvmReferenceItemCompileToCachePath)" Outputs="%(IkvmReferenceItemCompileToCachePath.CachePath)" Condition=" '@(IkvmReferenceItemCompileToCachePath.CachePath)' != '' ">
        <Error Text="IKVM references are not yet supported for '$(TargetFramework)' projects." Condition=" '$(IkvmToolFramework)' == 'netcoreapp3.1' And '$(TargetFramework)' != 'netcoreapp3.1' " />

        <!-- Take IkvmReferenceItem for the current batch on CachePath. -->
        <PropertyGroup>
            <IkvmReferenceItemToCompileCachePath>%(IkvmReferenceItemCompileToCachePath.CachePath)</IkvmReferenceItemToCompileCachePath>
        </PropertyGroup>
        <ItemGroup>
            <IkvmReferenceItemToCompile Include="@(IkvmReferenceItem)" Condition=" '%(IkvmReferenceItem.CachePath)' == '$(IkvmReferenceItemToCompileCachePath)' " />
        </ItemGroup>

        <!-- Output to stage path then copy to cache path to be atomic. -->
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(IkvmReferenceItem.StagePath)'))" />
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(IkvmReferenceItem.CachePath)'))" />

        <!-- Compile the reference item. -->
        <IkvmCompiler
            ToolPath="$(IkvmcTool)"
            UseDotNetExec="$(IkvmUseDotNetExec)"
            ResponseFile="%(IkvmReferenceItem.StagePath).rsp"
            Output="%(IkvmReferenceItem.StagePath)"
            Assembly="%(IkvmReferenceItem.AssemblyName)"
            Version="%(IkvmReferenceItem.AssemblyVersion)"
            Runtime="@(IkvmRuntimeAssembly)"
            Debug="%(IkvmReferenceItem.Debug)"
            CompressResources="true"
            Target="library"
            NoStdLib="$(IkvmcToolNoStdLib)"
            References="@(IkvmFrameworkReference);%(IkvmReferenceItem.ResolvedReferences)"
            Input="%(IkvmReferenceItem.Compile)"
            Condition=" '%(IkvmReferenceItem.Compile)' != '' "/>
        <Copy
            SourceFiles="%(IkvmReferenceItem.StagePath)"
            DestinationFiles="%(IkvmReferenceItem.CachePath)"
            OverwriteReadOnlyFiles="true" />
    </Target>

    <PropertyGroup>
        <CompileIkvmReferencesDependsOn>
            $(CompileIkvmReferenceAssemblies);
            GetReferenceAssemblyPaths;
            GetIkvmReferenceItems;
            GetIkvmReferenceItemsCompileToCachePath;
            GetIkvmFrameworkReferences;
            _CompileIkvmReferences;
        </CompileIkvmReferencesDependsOn>
    </PropertyGroup>

    <Target Name="CompileIkvmReferences" DependsOnTargets="$(CompileIkvmReferencesDependsOn)">

    </Target>

    <!-- Ensure the IkvmReference assemblies are built before compile. -->
    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <CompileDependsOn>
            CompileIkvmReferences;
            $(CompileDependsOn);
        </CompileDependsOn>
    </PropertyGroup>

    <!-- Adds the expected IkvmReferences to the Reference set. -->
    <Target Name="_ResolveIkvmReferences" DependsOnTargets="GetIkvmReferenceItems">
        <ItemGroup>
            <ReferencePath Include="@(IkvmReferenceItem->'%(CachePath)')">
                <ReferenceSourceTarget>ResolveIkvmReferences</ReferenceSourceTarget>
                <Aliases>%(IkvmReferenceItem.Aliases)</Aliases>
            </ReferencePath>
            <ReferenceCopyLocalPaths Include="@(IkvmReferenceItem->'%(CachePath)')">
                <ReferenceSourceTarget>ResolveIkvmReferences</ReferenceSourceTarget>
                <Aliases>%(IkvmReferenceItem.Aliases)</Aliases>
            </ReferenceCopyLocalPaths>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <ResolveIkvmReferencesDependsOn>
            $(ResolveIkvmReferencesDependsOn);
            GetIkvmReferenceItems;
            _ResolveIkvmReferences;
        </ResolveIkvmReferencesDependsOn>
    </PropertyGroup>

    <Target Name="ResolveIkvmReferences" DependsOnTargets="$(ResolveIkvmReferencesDependsOn)">

    </Target>

    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <ResolveReferencesDependsOn>
            $(ResolveReferencesDependsOn);
            ResolveIkvmReferences;
        </ResolveReferencesDependsOn>
    </PropertyGroup>

</Project>
