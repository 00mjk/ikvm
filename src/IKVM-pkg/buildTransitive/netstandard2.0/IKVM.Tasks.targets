<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <!--
    This file contains targets which invoke the jobs in 'Task' mode. The tasks provided by MSBuild are used.
    -->

    <!-- Populates the IkvmReferenceItem set with required metadata. -->
    <Target Name="_UpdateIkvmReferenceItemsMetadata" DependsOnTargets="GetIkvmReferenceItemsFromIkvmReferences;ResolveIkvmRuntimeAssembly;ResolveIkvmRuntimeJNIAssembly;ResolveIkvmBaseAssembly;ResolveIkvmFrameworkReferences" Condition=" '@(IkvmReferenceItem)' != '' ">

        <!-- Populates metadata, validates, resolves references, and emits in build order. -->
        <IkvmReferenceItemPrepare Items="@(IkvmReferenceItem)" ToolVersion="$(IkvmVersion)" ToolFramework="$(IkvmToolFramework)" RuntimeAssembly="$(IkvmRuntimeAssembly)" References="$(IkvmBaseAssembly);$(IkvmRuntimeAssembly);$(IkvmRuntimeJNIAssembly);@(IkvmFrameworkReference)" StageDir="$(IkvmStageDir)" CacheDir="$(IkvmCacheDir)">
            <Output TaskParameter="Items" ItemName="_IkvmReferenceItemWithMetadata" />
        </IkvmReferenceItemPrepare>

        <!-- Assign newly discovered items. -->
        <ItemGroup>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)"/>
            <IkvmReferenceItem Include="@(_IkvmReferenceItemWithMetadata)" />
        </ItemGroup>
    </Target>

    <!-- Builds the IkvmReferenceItem set into their output items within the cache. -->
    <Target Name="_CompileIkvmReferences" DependsOnTargets="ResolveIkvmRuntimeAssembly;ResolveIkvmReferenceAssemblies" Inputs="%(IkvmReferenceItem.Compile)" Outputs="%(IkvmReferenceItem.CachePath)">

        <!-- Output to stage path then copy to cache path to be atomic. -->
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(IkvmReferenceItem.StagePath)'))" />
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(IkvmReferenceItem.CachePath)'))" />

        <!-- Compile the reference item to the stage path. -->
        <IkvmCompiler
            ToolPath="$(IkvmCompilerToolPath)"
            ToolFramework="$(IkvmToolFramework)"
            ResponseFile="%(IkvmReferenceItem.StagePath).rsp"
            Output="%(IkvmReferenceItem.StagePath)"
            Assembly="%(IkvmReferenceItem.AssemblyName)"
            Version="%(IkvmReferenceItem.AssemblyVersion)"
            FileVersion="%(IkvmReferenceItem.AssemblyFileVersion)"
            Runtime="$(IkvmRuntimeAssembly)"
            Target="library"
            Debug="%(IkvmReferenceItem.Debug)"
            KeyFile="%(IkvmReferenceItem.KeyFile)"
            DelaySign="%(IkvmReferenceItem.DelaySign)"
            CompressResources="true"
            ClassLoader="%(IkvmReferenceItem.ClassLoader)"
            NoStdLib="true"
            References="$(IkvmRuntimeAssembly);$(IkvmRuntimeJNIAssembly);$(IkvmBaseAssembly);@(IkvmFrameworkReference);@(_IkvmReferenceItemResolvedReference->Distinct())"
            Input="%(IkvmReferenceItem.Compile)"
            Condition=" '%(IkvmReferenceItem.Compile)' != '' "/>

        <!-- Copy the compiled assembly to its cache path. -->
        <Copy
            SourceFiles="%(IkvmReferenceItem.StagePath)"
            DestinationFiles="%(IkvmReferenceItem.CachePath)"
            OverwriteReadOnlyFiles="true" />

        <ItemGroup>
            <FileWrites Include="%(IkvmReferenceItem.StagePath)" />
            <FileWrites Include="%(IkvmReferenceItem.StagePath).rsp" />
        </ItemGroup>
    </Target>

</Project>