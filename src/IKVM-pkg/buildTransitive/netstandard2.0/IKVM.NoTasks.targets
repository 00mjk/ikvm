<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <!--
    This file contains targets which invoke the jobs in 'NoTask' mode. The tasks provided by MSBuild are not used.
    -->

    <!-- Populates the IkvmReferenceItem set with required metadata. -->
    <Target Name="_UpdateIkvmReferenceItemsMetadata" DependsOnTargets="GetIkvmReferenceItemsFromIkvmReferences;ResolveIkvmRuntimeAssembly;ResolveIkvmRuntimeJNIAssembly;ResolveIkvmBaseAssembly;ResolveIkvmFrameworkReferences" Condition=" '@(IkvmReferenceItem)' != '' ">
        <GetFileHash Files="@(IkvmReferenceItem)" MetadataName="IkvmIdentity">
            <Output TaskParameter="Items" ItemName="_IkvmReferenceItemWithIdentity" />
        </GetFileHash>

        <!-- Partial implementation: assume JAR files, take file name as assembly name. Good enough for bootstrapping. -->
        <ItemGroup>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)" />
            <IkvmReferenceItem Include="@(_IkvmReferenceItemWithIdentity)">
                <Compile>%(FullPath)</Compile>
                <AssemblyName>%(Filename)</AssemblyName>
                <AssemblyVersion>1.0.0.0</AssemblyVersion>
                <AssemblyFileVersion>1.0.0.0</AssemblyFileVersion>
                <StagePath>$(IntermediateOutputPath)ikvm\stage\%(IkvmIdentity)\%(Filename).dll</StagePath>
                <CachePath>$(IntermediateOutputPath)ikvm\cache\%(IkvmIdentity)\%(Filename).dll</CachePath>
            </IkvmReferenceItem>
        </ItemGroup>
    </Target>

    <!-- Builds the IkvmReferenceItem set into their output items within the cache. -->
    <Target Name="_CompileIkvmReferences" DependsOnTargets="ResolveIkvmCompiler;ResolveIkvmRuntimeAssembly;ResolveIkvmRuntimeJNIAssembly;ResolveIkvmBaseAssembly;ResolveIkvmFrameworkReferences;_GetIkvmReferenceItemsCompileToCachePath" Inputs="@(_IkvmReferenceItemCompileToCachePath)" Outputs="%(_IkvmReferenceItemCompileToCachePath.CachePath)" Condition=" '@(_IkvmReferenceItemCompileToCachePath.CachePath)' != '' ">
        <!-- Take IkvmReferenceItem for the current batch on CachePath. -->
        <PropertyGroup>
            <_IkvmReferenceItemToCompileCachePath>%(_IkvmReferenceItemCompileToCachePath.CachePath)</_IkvmReferenceItemToCompileCachePath>
        </PropertyGroup>
        <ItemGroup>
            <_IkvmReferenceItemToCompile Remove="@(_IkvmReferenceItemToCompile)" />
            <_IkvmReferenceItemToCompile Include="@(IkvmReferenceItem)" Condition=" '%(IkvmReferenceItem.CachePath)' == '$(_IkvmReferenceItemToCompileCachePath)' " />
            <_IkvmReferenceItemResolvedReference Remove="@(_IkvmReferenceItemResolvedReference)" />
            <_IkvmReferenceItemResolvedReference Include="%(_IkvmReferenceItemToCompile.ResolvedReferences)" />
        </ItemGroup>

        <!-- Output to stage path then copy to cache path to be atomic. -->
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(_IkvmReferenceItemToCompile.StagePath)'))" />
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(_IkvmReferenceItemToCompile.CachePath)'))" />

        <ItemGroup>
            <_IkvmCompilerArgs Remove="@(_IkvmCompilerArgs)" />
            <_IkvmCompilerArgs Include="-debug" Condition=" '%(_IkvmReferenceItemToCompile.Debug)' == 'true' " />
            <_IkvmCompilerArgs Include="-assembly:%(_IkvmReferenceItemToCompile.AssemblyName)" />
            <_IkvmCompilerArgs Include="-version:%(_IkvmReferenceItemToCompile.AssemblyVersion)" Condition=" '%(_IkvmReferenceItemToCompile.AssemblyVersion)' != '' " />
            <_IkvmCompilerArgs Include="-fileversion:%(_IkvmReferenceItemToCompile.AssemblyFileVersion)" Condition=" '%(_IkvmReferenceItemToCompile.AssemblyFileVersion)' != '' " />
            <_IkvmCompilerArgs Include="-runtime:$(IkvmRuntimeAssembly)" />
            <_IkvmCompilerArgs Include="-keyfile:%(_IkvmReferenceItemToCompile.KeyFile)" Condition=" '%(_IkvmReferenceItemToCompile.KeyFile)' != '' " />
            <_IkvmCompilerArgs Include="-delaysign:%(_IkvmReferenceItemToCompile.DelaySign)" Condition=" '%(_IkvmReferenceItemToCompile.DelaySign)' == 'true' " />
            <_IkvmCompilerArgs Include="-compressresources" />
            <_IkvmCompilerArgs Include="-strictfinalfieldsemantics" Condition=" '$(StrictFinalFieldSemantics)' == 'true' " />
            <_IkvmCompilerArgs Include="-removeassertions" Condition=" '$(RemoveAssertions)' == 'true' " />
            <_IkvmCompilerArgs Include="-target:library" />
            <_IkvmCompilerArgs Include="-nostdlib" />
            <_IkvmCompilerArgs Include="-classloader:%(_IkvmReferenceItemToCompile.ClassLoader)" Condition=" '%(_IkvmReferenceItemToCompile.ClassLoader)' != '' " />
            <_IkvmCompilerReferencePath Remove="@(_IkvmCompilerReferencePath)" />
            <_IkvmCompilerReferencePath Include="@(IkvmFrameworkReference);$(IkvmBaseAssembly);$(IkvmRuntimeAssembly);$(IkvmRuntimeJNIAssembly);@(_IkvmReferenceItemResolvedReference->Distinct())" />
            <_IkvmCompilerArgs Include="@(_IkvmCompilerReferencePath->'-reference:%(FullPath)')" />
            <_IkvmCompilerArgs Include="-out:%(_IkvmReferenceItemToCompile.StagePath)" />
            <_IkvmCompilerArgs Include="%(_IkvmReferenceItemToCompile.Compile)" />
        </ItemGroup>
        <WriteLinesToFile File="%(_IkvmReferenceItemToCompile.StagePath).rsp" Lines="@(_IkvmCompilerArgs)" Overwrite="true" />
        
        <Delete Files="%(_IkvmReferenceItemToCompile.StagePath)" Condition="Exists('%(_IkvmReferenceItemToCompile.StagePath)')" />
        <Exec Command="$(IkvmCompilerExec) @%(_IkvmReferenceItemToCompile.StagePath).rsp" />
        <Copy SourceFiles="%(_IkvmReferenceItemToCompile.StagePath)" DestinationFiles="%(_IkvmReferenceItemToCompile.CachePath)" OverwriteReadOnlyFiles="true" />

        <ItemGroup>
            <FileWrites Include="%(_IkvmReferenceItemToCompile.StagePath)" />
            <FileWrites Include="%(_IkvmReferenceItemToCompile.StagePath).rsp" />
        </ItemGroup>
    </Target>

</Project>
