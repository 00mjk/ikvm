<Project>

    <PropertyGroup>
        <JavaAssemblyStageDir Condition=" '$(JavaAssemblyStageDir)' == '' ">$(IntermediateOutputPath)ikvm-stage\</JavaAssemblyStageDir>
        <JavaAssemblyCacheDir Condition=" '$(JavaAssemblyCacheDir)' == '' ">$(IntermediateOutputPath)ikvm-cache\</JavaAssemblyCacheDir>
    </PropertyGroup>

    <!-- Transforms the JavaReference item group into JavaReferenceItem items. -->
    <Target Name="GetJavaReferenceItemsFromJavaReference">
        <ItemGroup>
            <JavaReferenceItems Include="@(JavaReference)">
                <AssemblyStagePath>$(JavaAssemblyStageDir)%(AssemblyName).dll</AssemblyStagePath>
                <AssemblyCachePath>$(JavaAssemblyCacheDir)%(AssemblyName).dll</AssemblyCachePath>
            </JavaReferenceItems>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetJavaReferenceItemsDependsOn>
            $(GetJavaReferenceItemsDependsOn);
            GetJavaReferenceItemsFromJavaReference;
        </GetJavaReferenceItemsDependsOn>
    </PropertyGroup>

    <!-- Assembles the set of JavaReferenceItems from various sources. -->
    <Target Name="GetJavaReferenceItems" DependsOnTargets="$(GetJavaReferenceItemsDependsOn)" Returns="@(JavaReferenceItems)">
        
    </Target>
    
    <!-- Builds the JavaReferenceItems into their output items within the cache. -->
    <Target Name="_BuildJavaReferenceAssemblies" DependsOnTargets="GetJavaReferenceItems;GetReferenceAssemblyPaths;ResolvePackageAssets" Inputs="@(JavaReferenceItems)" Outputs="%(AssemblyCachePath)">
        <ItemGroup>
            <!-- there is likely a more appropriate place to obtain the references for the framework -->
            <_IkvmcLibs Include="@(Reference)" />
        </ItemGroup>
        <Message Text="_IkvmcLibs: @(_IkvmcLibs)" />
        <ItemGroup>
            <_IkvmcArgs Include="-debug" Condition=" '$(DebugSymbols)' == 'true' Or '$(DebugType)' != 'none' " />
            <_IkvmcArgs Include="-assembly:%(JavaReferenceItems.AssemblyName)" />
            <_IkvmcArgs Include="-version:%(JavaReferenceItems.AssemblyVersion)" />
            <_IkvmcArgs Include="-runtime:$(IkvmRuntimeDll)" />
            <_IkvmcArgs Include="-compressresources" />
            <_IkvmcArgs Include="-opt:fields" />
            <_IkvmcArgs Include="-strictfinalfieldsemantics" />
            <_IkvmcArgs Include="-removeassertions" />
            <_IkvmcArgs Include="-target:library" />
            <_IkvmcArgs Include="-sharedclassloader" />
            <_IkvmcArgs Include="-nowarn:110" />
            <_IkvmcArgs Include="-w4" />
            <_IkvmcArgs Include="-noparameterreflection" />
            <_IkvmcArgs Include="-nostdlib" />
            <_IkvmcArgs Include="@(_IkvmcLibs->'-reference:%(FullPath)')" />
            <_IkvmcArgs Include="%(JavaReferenceItems.FullPath)" />
        </ItemGroup>
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(JavaReferenceItems.AssemblyStagePath)'))" />
        <WriteLinesToFile File="%(JavaReferenceItems.AssemblyStagePath).cmd" Lines="@(_IkvmcArgs)" Overwrite="true" />
        <Exec Command="$(IkvmcToolExec) -out:%(JavaReferenceItems.AssemblyStagePath) @%(JavaReferenceItems.AssemblyStagePath).cmd" />

        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(JavaReferenceItems.AssemblyCachePath)'))" />
        <Copy SourceFiles="%(JavaReferenceItems.AssemblyStagePath)" DestinationFiles="%(JavaReferenceItems.AssemblyCachePath)" OverwriteReadOnlyFiles="true" />
    </Target>

    <PropertyGroup>
        <BuildJavaReferenceAssembliesDependsOn>
            $(BuildJavaReferenceAssembliesDependsOn);
            GetJavaReferenceItems;
            GetReferenceAssemblyPaths;
            _BuildJavaReferenceAssemblies;
        </BuildJavaReferenceAssembliesDependsOn>
    </PropertyGroup>

    <Target Name="BuildJavaReferenceAssemblies" DependsOnTargets="$(BuildJavaReferenceAssembliesDependsOn)">

    </Target>

    <Target Name="ResolveJavaReferenceAssemblies" DependsOnTargets="BuildJavaReferenceAssemblies" BeforeTargets="ResolveAssemblyReferences">
        <ItemGroup>
            <ReferencePath Include="@(JavaReferenceItem->'%(AssemblyCachePath)')" />
        </ItemGroup>
    </Target>

</Project>
