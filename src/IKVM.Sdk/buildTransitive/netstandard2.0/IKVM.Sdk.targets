<Project>

    <PropertyGroup>
        <JavaAssemblyStageDir Condition=" '$(JavaAssemblyStageDir)' == '' ">$(IntermediateOutputPath)ikvm-stage\</JavaAssemblyStageDir>
        <JavaAssemblyCacheDir Condition=" '$(JavaAssemblyCacheDir)' == '' ">$(IkvmHomeDir)cache\1\</JavaAssemblyCacheDir>
    </PropertyGroup>

    <!-- Gathers those references which are either related to the Framework itself, or IKVM. -->
    <Target Name="GetJavaFrameworkReferences" DependsOnTargets="GetReferenceAssemblyPaths;ResolvePackageAssets">
        <ItemGroup>
            <JavaFrameworkReference Include="@(Reference)" Condition=" '%(Reference.NuGetIsFrameworkReference)' == 'true' Or '%(Reference.FrameworkReferenceName)' != '' " />
            <JavaFrameworkReference Include="@(Reference)" Condition=" '%(Reference.NuGetPackageId)' == 'IKVM' " />
            <IkvmRuntimeAssembly Include="@(Reference)" Condition=" '%(Reference.NuGetPackageId)' == 'IKVM' And '%(Filename)%(Extension)' == 'IKVM.Runtime.dll' " />
        </ItemGroup>
    </Target>

    <!-- Transforms the JavaReference item group into JavaReferenceItem items. -->
    <Target Name="GetJavaReferenceItemsFromJavaReferences" DependsOnTargets="GetJavaFrameworkReferences">
        <ItemGroup>
            <_JavaReferenceItem Include="@(JavaReference)">
                <ToolFramework>$(IkvmToolFramework)</ToolFramework>
            </_JavaReferenceItem>
        </ItemGroup>

        <!-- Probes for default metadata from the reference item. -->
        <IkvmAssignJavaReferenceItemMetadata Items="@(_JavaReferenceItem)">
            <Output TaskParameter="Items" ItemName="_JavaReferenceItemWithMetadata" />
        </IkvmAssignJavaReferenceItemMetadata>

        <Message Text="IkvmRuntimeDll: $(IkvmRuntimeDll)" />
        <!-- Probes for default metadata from the reference item. -->
        <IkvmAssignJavaReferenceItemIdentity Items="@(_JavaReferenceItemWithMetadata)" References="@(JavaFrameworkReference)" RuntimeAssembly="@(IkvmRuntimeAssembly)">
            <Output TaskParameter="Items" ItemName="_JavaReferenceItemWithIdentity" />
        </IkvmAssignJavaReferenceItemIdentity>

        <!-- Cache path is determined based on the identity. -->
        <ItemGroup>
            <JavaReferenceItem Include="@(_JavaReferenceItemWithIdentity)">
                <AssemblyCachePath>$(JavaAssemblyCacheDir)%(IkvmIdentity)\%(AssemblyName).dll</AssemblyCachePath>
                <AssemblyStagePath>$(JavaAssemblyStageDir)%(IkvmIdentity)\%(AssemblyName).dll</AssemblyStagePath>
            </JavaReferenceItem>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetJavaReferenceItemsDependsOn>
            $(GetJavaReferenceItemsDependsOn);
            GetJavaFrameworkReferences;
            GetJavaReferenceItemsFromJavaReferences;
        </GetJavaReferenceItemsDependsOn>
    </PropertyGroup>

    <!-- Assembles the set of JavaReferenceItems from various sources. -->
    <Target Name="GetJavaReferenceItems" DependsOnTargets="$(GetJavaReferenceItemsDependsOn)" Returns="@(JavaReferenceItem)">

    </Target>

    <!-- Builds the JavaReferenceItems into their output items within the cache. -->
    <Target Name="_BuildJavaReferenceAssemblies" DependsOnTargets="GetJavaReferenceItems;GetReferenceAssemblyPaths;ResolvePackageAssets" Inputs="@(JavaReferenceItem)" Outputs="%(JavaReferenceItem.AssemblyCachePath)">
        <ItemGroup>
            <_IkvmcReferences Include="@(JavaFrameworkReference)" />
        </ItemGroup>
        <PropertyGroup>
            <_IkvmcNoStdLib Condition=" '$(IkvmToolFramework)' == 'netcoreapp3.1' ">true</_IkvmcNoStdLib>
        </PropertyGroup>

        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(JavaReferenceItem.AssemblyStagePath)'))" />
        <IkvmCompiler
            ToolPath="$(IkvmcTool)"
            UseDotNetExec="$(IkvmUseDotNetExec)"
            ResponseFile="%(JavaReferenceItem.AssemblyStagePath).rsp"
            Output="%(JavaReferenceItem.AssemblyStagePath)"
            Debug="%(JavaReferenceItem.Debug)"
            Assembly="%(JavaReferenceItem.AssemblyName)"
            Version="%(JavaReferenceItem.AssemblyVersion)"
            Runtime="@(IkvmRuntimeAssembly)"
            CompressResources="true"
            Target="library"
            NoStdLib="$(_IkvmcNoStdLib)"
            References="@(_IkvmcReferences)"
            Input="%(JavaReferenceItem.FullPath)" />

        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(JavaReferenceItem.AssemblyCachePath)'))" />
        <Copy SourceFiles="%(JavaReferenceItem.AssemblyStagePath)" DestinationFiles="%(JavaReferenceItem.AssemblyCachePath)" OverwriteReadOnlyFiles="true" />

        <ItemGroup>
            <JavaAssemblyReference Include="%(JavaReferenceItem.Identity)" Condition=" '%(JavaReferenceItem.AssemblyCachePath)' != '' ">
                <HintPath>%(JavaReferenceItem.AssemblyCachePath)</HintPath>
                <Aliases>%(JavaReferenceItem.Aliases)</Aliases>
            </JavaAssemblyReference>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <BuildJavaReferenceAssembliesDependsOn>
            $(BuildJavaReferenceAssembliesDependsOn);
            GetReferenceAssemblyPaths;
            GetJavaReferenceItems;
            GetJavaFrameworkReferences;
            _BuildJavaReferenceAssemblies;
        </BuildJavaReferenceAssembliesDependsOn>
    </PropertyGroup>

    <Target Name="BuildJavaReferenceAssemblies" DependsOnTargets="$(BuildJavaReferenceAssembliesDependsOn)">

    </Target>

    <Target Name="ResolveJavaReferenceAssemblies" DependsOnTargets="BuildJavaReferenceAssemblies" BeforeTargets="ResolveAssemblyReferences">
        <ItemGroup>
            <Reference Include="@(JavaAssemblyReference)" />
        </ItemGroup>
    </Target>

</Project>
