<Project>

    <PropertyGroup>
        <JavaAssemblyStageDir Condition=" '$(JavaAssemblyStageDir)' == '' ">$(IntermediateOutputPath)ikvm-stage\</JavaAssemblyStageDir>
        <JavaAssemblyCacheDir Condition=" '$(JavaAssemblyCacheDir)' == '' ">$(IkvmHomeDir)cache\1\</JavaAssemblyCacheDir>
    </PropertyGroup>

    <!-- Transforms the JavaReference item group into JavaReferenceItem items. -->
    <Target Name="GetJavaReferenceItemsFromJavaReference">
        <ItemGroup>
            <JavaReferenceItems Include="@(JavaReference)">
                <AssemblyStagePath>$(JavaAssemblyStageDir)%(AssemblyName).dll</AssemblyStagePath>
                <AssemblyCachePath>$(JavaAssemblyCacheDir)%(AssemblyName).dll</AssemblyCachePath>
            </JavaReferenceItems>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetJavaReferenceItemsDependsOn>
            $(GetJavaReferenceItemsDependsOn);
            GetJavaReferenceItemsFromJavaReference;
        </GetJavaReferenceItemsDependsOn>
    </PropertyGroup>

    <!-- Assembles the set of JavaReferenceItems from various sources. -->
    <Target Name="GetJavaReferenceItems" DependsOnTargets="$(GetJavaReferenceItemsDependsOn)" Returns="@(JavaReferenceItems)">

    </Target>

    <!-- Builds the JavaReferenceItems into their output items within the cache. -->
    <Target Name="_BuildJavaReferenceAssemblies" DependsOnTargets="GetJavaReferenceItems;GetReferenceAssemblyPaths;ResolvePackageAssets" Inputs="@(JavaReferenceItems)" Outputs="dummy">
        <ItemGroup>
            <_IkvmcReferences Remove="@(_IkvmcReferences)" />
            <_IkvmcReferences Include="@(Reference);@(JavaAssemblyReference)" />
        </ItemGroup>
        <PropertyGroup>
            <_IkvmcNoStdLib Condition=" '$(IkvmToolFramework)' == 'netcoreapp3.1' ">true</_IkvmcNoStdLib>
        </PropertyGroup>
        
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(JavaReferenceItems.AssemblyStagePath)'))" />
        <IkvmCompiler
            ResponseFile="C:\Users\jhaltom\ikvmc.$(TargetFramework).txt"
            ToolPath="$(IkvmcTool)"
            UseDotNetExec="$(IkvmUseDotNetExec)"
            Output="%(JavaReferenceItems.AssemblyStagePath)"
            Debug="%(JavaReferenceItems.Debug)"
            Assembly="%(JavaReferenceItems.AssemblyName)"
            Version="%(JavaReferenceItems.AssemblyVersion)"
            Runtime="$(IkvmRuntimeDll)"
            CompressResources="true"
            Target="library"
            NoStdLib="$(_IkvmcNoStdLib)"
            References="@(_IkvmcReferences)"
            Input="%(JavaReferenceItems.FullPath)" />
        
        <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('%(JavaReferenceItems.AssemblyCachePath)'))" />
        <Copy SourceFiles="%(JavaReferenceItems.AssemblyStagePath)" DestinationFiles="%(JavaReferenceItems.AssemblyCachePath)" OverwriteReadOnlyFiles="true" />

        <ItemGroup>
            <JavaAssemblyReference Include="%(JavaReferenceItems.AssemblyCachePath)" Condition=" '%(JavaReferenceItems.AssemblyCachePath)' != '' ">
                <HintPath>%(JavaReferenceItems.AssemblyCachePath)</HintPath>
            </JavaAssemblyReference>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <BuildJavaReferenceAssembliesDependsOn>
            $(BuildJavaReferenceAssembliesDependsOn);
            GetJavaReferenceItems;
            GetReferenceAssemblyPaths;
            _BuildJavaReferenceAssemblies;
        </BuildJavaReferenceAssembliesDependsOn>
    </PropertyGroup>

    <Target Name="BuildJavaReferenceAssemblies" DependsOnTargets="$(BuildJavaReferenceAssembliesDependsOn)">

    </Target>

    <Target Name="ResolveJavaReferenceAssemblies" DependsOnTargets="BuildJavaReferenceAssemblies" BeforeTargets="ResolveAssemblyReferences">
        <ItemGroup>
            <Reference Include="@(JavaAssemblyReference)">
                <HintPath>%(JavaAssemblyReference.HintPath)</HintPath>
            </Reference>
        </ItemGroup>
    </Target>

</Project>
