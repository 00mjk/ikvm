<Project>
    <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />

    <PropertyGroup>
        <TargetFrameworks>net461;netcoreapp3.1</TargetFrameworks>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
        <TransformOnBuild>True</TransformOnBuild>
        <TransformOutOfDateOnly>false</TransformOutOfDateOnly>
    </PropertyGroup>

    <PropertyGroup>
        <OpenJdkDirSlash>./openjdk</OpenJdkDirSlash>
        <SkipSystemCoreDependency>false</SkipSystemCoreDependency>
        <OpenJdkImplementationVersion>1.8.0</OpenJdkImplementationVersion>
        <OpenJdkSpecificationVersion>1.8</OpenJdkSpecificationVersion>
        <OpenJdkFullVersion>1.8.0_45-b14</OpenJdkFullVersion>
        <OpenJdkVersion>OpenJDK 8u45 b14</OpenJdkVersion>
    </PropertyGroup>

    <PropertyGroup Label="NuGet Package/Assembly Settings">
        <RootNamespace>openjdk</RootNamespace>
        <AssemblyName>openjdk</AssemblyName>
        <AssemblyTitle>IKVM.NET Compiler</AssemblyTitle>
        <Description>JVM for Mono and .NET</Description>
    </PropertyGroup>

    <ItemGroup>
        <ProjectReference Include="..\IKVM.Runtime-ref\IKVM.Runtime-ref.csproj" />
        <ProjectReference Include="..\ikvmc\ikvmc.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
        <ProjectReference Include="..\ikvmstub\ikvmstub.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
    </ItemGroup>

    <ItemGroup Condition="$(TargetFramework.StartsWith('netstandard')) Or $(TargetFramework.StartsWith('netcore'))">
        <PackageReference Include="System.Security.Permissions" Version="$(SystemSecurityPermissionsPackageVersion)" GeneratePathProperty="true" />
        <PackageReference Include="System.Configuration.ConfigurationManager" Version="$(SystemConfigurationConfigurationManagerPackageVersion)" GeneratePathProperty="true" />
        <PackageReference Include="System.Drawing.Common" Version="$(SystemDrawingCommonPackageVersion)" GeneratePathProperty="true" />
        <PackageReference Include="Newtonsoft.Json" Version="$(NewtonsoftJsonPackageVersion)" />
        <PackageReference Include="System.IO.FileSystem.AccessControl" Version="$(SystemIOFileSystemAccessControlPackageVersion)" GeneratePathProperty="true" />
        <PackageReference Include="System.Security.AccessControl" Version="$(SystemSecurityAccessControlPackageVersion)" GeneratePathProperty="true" />
        <PackageReference Include="System.Security.Principal.Windows" Version="$(SystemSecurityPrincipalWindowsPackageVersion)" GeneratePathProperty="true" />
        <PackageReference Include="System.Data.Odbc" Version="$(SystemDataOdbcPackageVersion)" GeneratePathProperty="true" />
    </ItemGroup>

    <ItemDefinitionGroup>
        <StubAssembly>
            <Name></Name>
            <Args></Args>
        </StubAssembly>
    </ItemDefinitionGroup>

    <ItemGroup Condition="$(TargetFramework.StartsWith('net4'))">
        <StubAssembly Include="mscorlib" />
        <StubAssembly Include="System" />
        <StubAssembly Include="System.Core" />
        <StubAssembly Include="System.Data" />
        <StubAssembly Include="System.Xml" />
    </ItemGroup>

    <ItemGroup Condition="$(TargetFramework.StartsWith('netstandard')) Or $(TargetFramework.StartsWith('netcore'))">
        <StubAssembly Include="Microsoft.Win32.Primitives" />
        <StubAssembly Include="System.Collections.Specialized" />
        <StubAssembly Include="System.ComponentModel" />
        <StubAssembly Include="System.ComponentModel.Primitives" />
        <StubAssembly Include="System.ComponentModel.TypeConverter" />
        <StubAssembly Include="System.Console" />
        <StubAssembly Include="System.Data.Common" />
        <StubAssembly Include="System.Diagnostics.FileVersionInfo" />
        <StubAssembly Include="System.Diagnostics.Process" />
        <StubAssembly Include="System.Diagnostics.StackTrace" />
        <StubAssembly Include="System.Drawing.Primitives" />
        <StubAssembly Include="System.IO.FileSystem" />
        <StubAssembly Include="System.IO.FileSystem.DriveInfo" />
        <StubAssembly Include="System.IO.FileSystem.Watcher" />
        <StubAssembly Include="System.Net.Mail" />
        <StubAssembly Include="System.Net.NetworkInformation" />
        <StubAssembly Include="System.Net.Primitives" />
        <StubAssembly Include="System.Net.Sockets" />
        <StubAssembly Include="System.Runtime" />
        <StubAssembly Include="System.Runtime.Extensions" />
        <StubAssembly Include="System.Runtime.InteropServices" />
        <StubAssembly Include="System.Security.Cryptography.Algorithms" />
        <StubAssembly Include="System.Security.Cryptography.Csp" />
        <StubAssembly Include="System.Threading" />
        <StubAssembly Include="System.Threading.Thread" />
        <StubAssembly Include="System.Threading.ThreadPool" />
        <StubAssembly Include="System.Xml.ReaderWriter" />

        <StubAssembly Include="$(PkgSystem_IO_FileSystem_AccessControl)\ref\netstandard2.0\System.IO.FileSystem.AccessControl.dll">
            <Name>System.IO.FileSystem.AccessControl</Name>
            <Args>-r:$(PkgSystem_Security_AccessControl)\ref\netstandard2.0\System.Security.AccessControl.dll -r:$(PkgSystem_Security_Principal_Windows)\ref\netcoreapp3.0\System.Security.Principal.Windows.dll</Args>
        </StubAssembly>

        <StubAssembly Include="$(PkgSystem_Configuration_ConfigurationManager)\ref\netstandard2.0\System.Configuration.ConfigurationManager.dll">
            <Name>System.Configuration.ConfigurationManager</Name>
            <Args>-r:$(PkgSystem_Security_Permissions)\ref\netstandard2.0\System.Security.Permissions.dll</Args>
        </StubAssembly>

        <StubAssembly Include="$(PkgSystem_Data_Odbc)\ref\netstandard2.0\System.Data.Odbc.dll">
            <Name>System.Data.Odbc</Name>
        </StubAssembly>

        <StubAssembly Include="$(PkgSystem_Drawing_Common)\ref\netcoreapp3.0\System.Drawing.Common.dll">
            <Name>System.Drawing.Common</Name>
        </StubAssembly>

        <StubAssembly Include="$(PkgSystem_Security_Permissions)\ref\netstandard2.0\System.Security.Permissions.dll">
            <Name>System.Security.Permissions</Name>
            <Args>-r:$(PkgSystem_Security_AccessControl)\ref\netstandard2.0\System.Security.AccessControl.dll</Args>
        </StubAssembly>
    </ItemGroup>

    <ItemGroup>
      <Service Include="{508349b6-6b84-4df5-91f0-309beebad82d}" />
    </ItemGroup>

    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />

    <PropertyGroup>
        <CoreCompileDependsOn>
            $(CoreCompileDependsOn);
            StubJars;
        </CoreCompileDependsOn>
    </PropertyGroup>

    <Target Name="GetIkvmStubExe" DependsOnTargets="ResolveReferences">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\ikvmstub\ikvmstub.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="_IkvmStub" />
        </MSBuild>
        <PropertyGroup>
            <IkvmStub>@(_IkvmStub)</IkvmStub>
        </PropertyGroup>
    </Target>

    <Target Name="StubJars" DependsOnTargets="GetIkvmStubExe">
        <PropertyGroup>
            <StubOutputPath>$(IntermediateOutputPath)\stubs</StubOutputPath>
        </PropertyGroup>
        <MakeDir Directories="$(StubOutputPath)" />

        <PropertyGroup Condition="$(TargetFramework.StartsWith('net4'))">
            <IkvmStubExec>$(IkvmStub)</IkvmStubExec>
        </PropertyGroup>
        <PropertyGroup Condition="$(TargetFramework.StartsWith('netstandard')) Or $(TargetFramework.StartsWith('netcore'))">
            <IkvmStubExec>dotnet exec $(IkvmStub)</IkvmStubExec>
        </PropertyGroup>

        <Exec Command="$(IkvmStubExec) -forwarders -bootstrap @(StubAssembly) %(Args) -out:$(StubOutputPath)\%(Identity).jar" Condition=" '%(Name)' == '' " />
        <Exec Command="$(IkvmStubExec) -forwarders -bootstrap @(StubAssembly) %(Args) -out:$(StubOutputPath)\%(Name).jar" Condition=" '%(Name)' != '' " />
    </Target>

</Project>
