<Project>
    <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />

    <PropertyGroup>
        <TargetFrameworks>net461</TargetFrameworks>
        <AssemblyTitle>IKVM.NET Compiler</AssemblyTitle>
        <Description>JVM for Mono and .NET</Description>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    </PropertyGroup>

    <PropertyGroup>
        <OpenJdkDir>..\..\..\openjdk-8u45-b14</OpenJdkDir>
        <OpenJdkImplementationVersion>1.8.0</OpenJdkImplementationVersion>
        <OpenJdkSpecificationVersion>1.8</OpenJdkSpecificationVersion>
        <OpenJdkFullVersion>1.8.0_45-b14</OpenJdkFullVersion>
        <OpenJdkVersion>OpenJDK 8u45 b14</OpenJdkVersion>
    </PropertyGroup>

    <ItemGroup>
        <ProjectReference Include="..\IKVM.Runtime-ref\IKVM.Runtime-ref.csproj" />
        <ProjectReference Include="..\ikvmc\ikvmc.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
        <ProjectReference Include="..\ikvmstub\ikvmstub.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="System.CodeDom" Version="6.0.0" />
        <PackageReference Include="System.Data.OleDb" Version="6.0.0" />
        <PackageReference Include="System.Data.SqlClient" Version="4.8.3" />
        <PackageReference Include="System.Diagnostics.PerformanceCounter" Version="6.0.1" />
        <PackageReference Include="System.IO.Packaging" Version="6.0.0" />
        <PackageReference Include="System.IO.Pipes" Version="4.3.0" />
        <PackageReference Include="System.IO.Pipes.AccessControl" Version="5.0.0" />
        <PackageReference Include="System.IO.Ports" Version="6.0.0" />
        <PackageReference Include="System.Security.Cryptography.Xml" Version="6.0.0" />
        <PackageReference Include="System.Security.Permissions" Version="6.0.0" />
        <PackageReference Include="System.Configuration.ConfigurationManager" Version="6.0.0" />
        <PackageReference Include="System.Drawing.Primitives " Version="4.3.0" />
        <PackageReference Include="System.Drawing.Common" Version="6.0.0" />
        <PackageReference Include="System.IO.FileSystem.AccessControl" Version="5.0.0" />
        <PackageReference Include="System.Security.AccessControl" Version="6.0.0" />
        <PackageReference Include="System.Security.Principal.Windows" Version="5.0.0" />
        <PackageReference Include="System.Security.Cryptography.Cng" Version="5.0.0" />
        <PackageReference Include="System.ServiceModel.Syndication" Version="6.0.0" />
        <PackageReference Include="System.ServiceProcess.ServiceController" Version="6.0.0" />
        <PackageReference Include="System.Threading.AccessControl" Version="6.0.0" />
        <PackageReference Include="System.Data.Odbc" Version="6.0.0" />
        <PackageReference Include="Newtonsoft.Json" Version="12.0.3" />
    </ItemGroup>

    <ItemDefinitionGroup>
        <JavaSource>
            <TargetFramework></TargetFramework>
        </JavaSource>
        <JavaSourceTemplate>
            <TargetFramework></TargetFramework>
        </JavaSourceTemplate>
        <StubAssembly>
            <Args></Args>
        </StubAssembly>
    </ItemDefinitionGroup>

    <ItemGroup>
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\calendars.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\logging.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\net.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\psfontj2d.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\sound.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\tzdb.dat" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\currency.data" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\management\management.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\cmm\*" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\security\java.policy" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\security\java.security" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\security\US_export_policy.jar" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\jdk\src\windows\**\lib\flavormap.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\jdk\src\windows\**\lib\content-types.properties" />
    </ItemGroup>

    <ItemGroup>
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\com\sun\corba\se\impl\orbutil\resources\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\com\sun\rowset\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\javax\swing\text\html\parser\html32.bdtd" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\rmi\registry\resources\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\rmi\server\resources\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\text\resources\*IteratorData" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\text\resources\th\*IteratorData_th" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\text\resources\th\thai_dict" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\corba\src\share\classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.gif" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.png" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.wav" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\com\sun\org\apache\xml\internal\security\resource\config.*" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\com\sun\swing\internal\plaf\**\*" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\javax\swing\text\html\default.css" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\javax\swing\text\rtf\charsets\*.txt" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\sun\text\resources\**\*.icu" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxp\src\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxp\src\**\*.res" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxws\src\share\jaf_classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxws\src\share\jaxws_classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxws\src\share\jaxws_classes\**\*.xml" />
    </ItemGroup>

    <ItemGroup>
        <JavaSource Include="source\**\*.java" SourcePath="%(RecursiveDir)%(Filename)%(Extension)" />
        <JavaSource Update="source\**\*.netcoreapp3_1.java" SourcePath="%(RecursiveDir)%(Filename)" TargetFramework="netcoreapp3.1" />
        <JavaSource Update="source\**\*.net461.java" SourcePath="%(RecursiveDir)%(Filename)" TargetFramework="net461" />
        <JavaSourceTemplate Include="source\**\*.java.in" SourcePath="%(RecursiveDir)%(Filename)" />
        <JavaSourceTemplate Update="source\**\*.netcoreapp3_1.java.in" SourcePath="%(RecursiveDir)%(Filename)" TargetFramework="netcoreapp3.1" />
        <JavaSourceTemplate Update="source\**\*.net461.java.in" SourcePath="%(RecursiveDir)%(Filename)" TargetFramework="net461" />
    </ItemGroup>

    <ItemGroup>
        <JavaResource Include="resources\**\*" ResourcePath="%(RecursiveDir)%(Filename)%(Extension)" />
        <JavaResource Update="resources\**\*.netcoreapp3_1" ResourcePath="%(RecursiveDir)%(Filename)" TargetFramework="netcoreapp3.1" />
        <JavaResource Update="resources\**\*.net461" ResourcePath="%(RecursiveDir)%(Filename)" TargetFramework="net461" />
        <JavaResourceTemplate Include="resources\**\*.in" ResourcePath="%(RecursiveDir)%(Filename)" />
        <JavaResourceTemplate Update="source\**\*.netcoreapp3_1.in" ResourcePath="%(RecursiveDir)%(Filename)" TargetFramework="netcoreapp3.1" />
        <JavaResourceTemplate Update="source\**\*.net461.in" ResourcePath="%(RecursiveDir)%(Filename)" TargetFramework="net461" />
    </ItemGroup>

    <ItemGroup>
        <OpenJdkClasspath Include="$(OpenJdkDir)\jdk\src\share\classes" />
        <OpenJdkClasspath Include="$(OpenJdkDir)\corba\src\share\classes" />
        <OpenJdkClasspath Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\gensrc" />
    </ItemGroup>

    <Import Project="openjdk.props" />

    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />

    <UsingTask TaskName="TransformTemplates" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Using Namespace="System.Text.RegularExpressions" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                foreach (var i in Items)
                {
                    var fullPath = i.GetMetadata("FullPath");
                    var destPath = i.GetMetadata("Destination");
                    Directory.CreateDirectory(Path.GetDirectoryName(destPath));
                    File.Copy(fullPath, destPath, true);
                }
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <UsingTask TaskName="DistinctSourceItems" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Source ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
            <Output ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                var hs = new Dictionary<string, ITaskItem>();
                foreach (var i in Source)
                    hs[i.GetMetadata("Key")] = i;
                Output = hs.Values.ToArray();
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <PropertyGroup>
        <JavaSourceTemplateOutputPath>$(IntermediateOutputPath)sources</JavaSourceTemplateOutputPath>
        <JavaResourceTemplateOutputPath>$(IntermediateOutputPath)resources</JavaResourceTemplateOutputPath>
        <StubsOutputPath>$(IntermediateOutputPath)stubs</StubsOutputPath>
        <RmiStubsOutputPath>$(IntermediateOutputPath)rmistubs</RmiStubsOutputPath>
        <VfsZipTempPath>$(IntermediateOutputPath)vfs_zip</VfsZipTempPath>
        <VfsZipPath>$(IntermediateOutputPath)vfs.zip</VfsZipPath>
        <ResourcesZipTempPath>$(IntermediateOutputPath)resources_zip</ResourcesZipTempPath>
        <ResourcesZipPath>$(IntermediateOutputPath)resources.zip</ResourcesZipPath>
        <JavaClassOutputPath>$(IntermediateOutputPath)classes</JavaClassOutputPath>
        <OpenJdkAssemblyPath>$(IntermediateOutputPath)openjdk.dll</OpenJdkAssemblyPath>
    </PropertyGroup>

    <PropertyGroup>
        <BuildDependsOn>
            BuildOpenJdkAssembly;
            $(BuildDependsOn);
        </BuildDependsOn>
    </PropertyGroup>

    <Target Name="GetIkvmStubExe" DependsOnTargets="ResolveProjectReferences">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\ikvmstub\ikvmstub.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="_IkvmStub" />
        </MSBuild>
        <PropertyGroup>
            <IkvmStub>@(_IkvmStub)</IkvmStub>
        </PropertyGroup>
    </Target>

    <Target Name="ResolveIkvmRuntimeAssembly">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\IKVM.Runtime-ref\IKVM.Runtime-ref.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="StubAssembly" />
        </MSBuild>
    </Target>

    <Target Name="ResolveStubs" DependsOnTargets="ResolveIkvmRuntimeAssembly;ResolveProjectReferences;ResolveAssemblyReferences">
        <PropertyGroup>
            <_StubArgs>@(_ResolveAssemblyReferenceResolvedFiles->'-r:"%(Identity)"', ' ')</_StubArgs>
        </PropertyGroup>
        <ItemGroup>
            <_StubAssembly Include="@(_ResolveAssemblyReferenceResolvedFiles)">
                <JarPath>$(StubsOutputPath)\%(Filename).jar</JarPath>
                <Args>$(_StubArgs)</Args>
            </_StubAssembly>
        </ItemGroup>
    </Target>

    <Target Name="BuildStubs" DependsOnTargets="ResolveStubs;GetIkvmStubExe" Inputs="@(_StubAssembly)" Outputs="%(JarPath)">
        <MakeDir Directories="$(StubsOutputPath)" />

        <!-- this is wrong, determination of which version to use to build needs to be based on which platform we're running on -->
        <PropertyGroup Condition="$(TargetFramework.StartsWith('net4'))">
            <IkvmStubExec>$(IkvmStub)</IkvmStubExec>
        </PropertyGroup>
        <PropertyGroup Condition="$(TargetFramework.StartsWith('netstandard')) Or $(TargetFramework.StartsWith('netcore'))">
            <IkvmStubExec>dotnet exec $(IkvmStub)</IkvmStubExec>
        </PropertyGroup>

        <Message Text="$(IkvmStubExec) -forwarders -bootstrap &quot;@(_StubAssembly)&quot; %(Args) -out:%(JarPath)" Condition=" '%(Identity)' != '' " Importance="high" />
        <Exec Command="$(IkvmStubExec) -forwarders -bootstrap &quot;@(_StubAssembly)&quot; %(Args) -out:%(JarPath)" Condition=" '%(Identity)' != '' " />

        <ItemGroup>
            <StubJar Include="@(_StubAssembly->'%(JarPath)')" />
            <FileWrites Include="@(_StubAssembly->'%(JarPath)')" />
        </ItemGroup>
    </Target>

    <Target Name="BuildVfsZip" Inputs="@(VfsZipIncludeFile)" Outputs="$(VfsZipPath)">
        <Delete Files="$(VfsZipTempPath)\**\*" />
        <RemoveDir Directories="$(VfsZipTempPath)" />
        <MakeDir Directories="$(VfsZipTempPath)" />
        <Copy SourceFiles="@(VfsZipIncludeFile)" DestinationFolder="$(VfsZipTempPath)\%(RecursiveDir)" />
        <Delete Files="$(VfsZipPath)" />
        <ZipDirectory SourceDirectory="$(VfsZipTempPath)" DestinationFile="$(VfsZipPath)" />
        <ItemGroup>
            <FileWrites Include="$(VfsZipTempPath)\**\*" />
            <FileWrites Include="$(VfsZipPath)" />
        </ItemGroup>
    </Target>

    <Target Name="BuildResourcesZip" Inputs="@(ResourcesZipIncludeFile)" Outputs="$(ResourcesZipPath)">
        <Delete Files="$(ResourcesZipTempPath)\**\*" />
        <RemoveDir Directories="$(ResourcesZipTempPath)" />
        <MakeDir Directories="$(ResourcesZipTempPath)" />
        <Copy SourceFiles="@(ResourcesZipIncludeFile)" DestinationFolder="$(ResourcesZipTempPath)\%(RecursiveDir)" />
        <Delete Files="$(ResourcesZipPath)" />
        <ZipDirectory SourceDirectory="$(ResourcesZipTempPath)" DestinationFile="$(ResourcesZipPath)" />
        <ItemGroup>
            <FileWrites Include="$(ResourcesZipTempPath)\**\*" />
            <FileWrites Include="$(ResourcesZipPath)" />
        </ItemGroup>
    </Target>

    <Target Name="ResolveTransformJavaSourceTemplates">
        <Message Text="JavaSourceTemplate: @(JavaSourceTemplate)" Importance="high" />
        <ItemGroup>
            <TransformJavaSourceTemplate Include="@(JavaSourceTemplate)" Condition=" '%(JavaSourceTemplate.TargetFramework)' == '' Or '%(TargetFramework)' == '$(TargetFramework)' ">
                <Destination>$(JavaSourceTemplateOutputPath)\%(SourcePath)</Destination>
            </TransformJavaSourceTemplate>
        </ItemGroup>
    </Target>

    <Target Name="TransformJavaSourceTemplates" DependsOnTargets="ResolveTransformJavaSourceTemplates" Inputs="@(TransformJavaSourceTemplate)" Outputs="@(TransformJavaSourceTemplate->'%(Destination)')">
        <Message Text="TransformJavaSourceTemplate: @(TransformJavaSourceTemplate)" Importance="high" />
        <MakeDir Directories="$(JavaSourceTemplateOutputPath)" />
        <TransformTemplates Items="@(TransformJavaSourceTemplate)" />
        <ItemGroup>
            <JavaSourceTemplateItem Include="@(TransformJavaSourceTemplate->'%(Destination)')" SourcePath="%(SourcePath)" />
            <FileWrites Include="@(TransformJavaSourceTemplate->'%(Destination)')" />
        </ItemGroup>
    </Target>

    <Target Name="_ResolveJavaSourceItems" DependsOnTargets="$(TransformJavaSourceTemplates)">
        <ItemGroup>
            <_JavaSourceItems Include="@(OpenJdkCompile)" Condition=" '%(Extension)' == '.java' ">
                <Key>%(SourcePath)</Key>
            </_JavaSourceItems>
            <_JavaSourceItems Include="@(JavaSource)" Condition=" '%(JavaSource.TargetFramework)' == '' Or '%(JavaSource.TargetFramework)' == '$(TargetFramework)' ">
                <Key>%(SourcePath)</Key>
            </_JavaSourceItems>
            <_JavaSourceItems Include="@(JavaSourceTemplateItem)">
                <Key>%(SourcePath)</Key>
            </_JavaSourceItems>
        </ItemGroup>
        <DistinctSourceItems Source="@(_JavaSourceItems)">
            <Output TaskParameter="Output" ItemName="_JavaSourceItemsDistinct" />
        </DistinctSourceItems>
        <ItemGroup>
            <JavaSourceItems Include="@(_JavaSourceItemsDistinct)" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <ResolveJavaSourceItemsDependsOn>
            ResolveTransformJavaSourceTemplates;
            TransformJavaSourceTemplates;
            _ResolveJavaSourceItems;
            $(ResolveJavaSourceItemsDependsOn);
        </ResolveJavaSourceItemsDependsOn>
    </PropertyGroup>

    <Target Name="ResolveJavaSourceItems" DependsOnTargets="$(ResolveJavaSourceItemsDependsOn)">

    </Target>

    <Target Name="ResolveTransformJavaResourceTemplates">
        <ItemGroup>
            <TransformJavaResourceTemplate Include="@(JavaResourceTemplate)">
                <Destination>$(JavaResourceTemplateOutputPath)\%(RecursiveDir)%(Filename)</Destination>
            </TransformJavaResourceTemplate>
        </ItemGroup>
    </Target>

    <Target Name="TransformJavaResourceTemplates" DependsOnTargets="ResolveTransformJavaResourceTemplates" Inputs="@(TransformJavaResourceTemplate)" Outputs="@(TransformJavaResourceTemplate->'%(Destination)')">
        <MakeDir Directories="$(JavaResourceTemplateOutputPath)" />
        <TransformTemplates Items="@(TransformJavaResourceTemplate)" />
        <ItemGroup>
            <JavaResourceTemplateItem Include="@(TransformJavaResourceTemplate->'%(Destination)')" ResourcePath="%(ResourcePath)" />
            <FileWrites Include="@(TransformJavaResourceTemplate->'%(Destination)')" />
        </ItemGroup>
    </Target>

    <Target Name="_ResolveJavaResourceItems" DependsOnTargets="TransformJavaResourceTemplates">
        <ItemGroup>
            <_JavaResourceItems Include="@(OpenJdkResource)">
                <Key>%(ResourcePath)</Key>
            </_JavaResourceItems>
            <_JavaResourceItems Include="@(JavaResource)" Condition=" '%(JavaResource.TargetFramework)' == '' Or '%(JavaResource.TargetFramework)' == '$(TargetFramework)' ">
                <Key>%(ResourcePath)</Key>
            </_JavaResourceItems>
            <_JavaResourceItems Include="@(JavaResourceTemplateItem)">
                <Key>%(ResourcePath)</Key>
            </_JavaResourceItems>
        </ItemGroup>
        <DistinctSourceItems Source="@(_JavaResourceItems)">
            <Output TaskParameter="Output" ItemName="_JavaResourceItemsDistinct" />
        </DistinctSourceItems>
        <ItemGroup>
            <JavaResourceItems Include="@(_JavaResourceItemsDistinct)" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <ResolveJavaResourceItemsDependsOn>
            ResolveTransformJavaResourceTemplates;
            TransformJavaResourceTemplates;
            _ResolveJavaResourceItems;
            $(ResolveJavaResourceItemsDependsOn);
        </ResolveJavaResourceItemsDependsOn>
    </PropertyGroup>

    <Target Name="ResolveJavaResourceItems" DependsOnTargets="$(ResolveJavaResourceItemsDependsOn)">

    </Target>

    <Target Name="ResolveJavaClasspath" DependsOnTargets="BuildStubs">
        <ItemGroup>
            <JavaClasspath Include="@(StubJar)" />
            <JavaClasspath Include="@(OpenJdkClasspath)" />
        </ItemGroup>
    </Target>

    <Target Name="_BuildJavaClasses" DependsOnTargets="ResolveJavaSourceItems;ResolveJavaClasspath" Inputs="@(JavaSourceItems)" Outputs="$(JavaClassOutputPath)\stamp">
        <Delete Files="$(IntermediateOutputPath)sources.list" />
        <WriteLinesToFile File="$(IntermediateOutputPath)sources.list" Lines="@(JavaSourceItems)" />
        <Delete Files="$(JavaClassOutputPath)\**\*" />
        <RemoveDir Directories="$(JavaClassOutputPath)" />
        <MakeDir Directories="$(JavaClassOutputPath)" />
        <Message Text="javac -J-Xmx1536M -g -nowarn -implicit:none -parameters -cp dummy -bootclasspath @(JavaClasspath) -d $(JavaClassOutputPath) @$(IntermediateOutputPath)sources.list" Importance="high" />
        <Exec Command="javac -J-Xmx1536M -g -nowarn -implicit:none -parameters -cp dummy -bootclasspath @(JavaClasspath) -d $(JavaClassOutputPath) @$(IntermediateOutputPath)sources.list" />
        <Touch Files="$(JavaClassOutputPath)\stamp" AlwaysCreate="true" ForceTouch="true" />
        <ItemGroup>
            <FileWrites Include="$(IntermediateOutputPath)sources.list" />
            <FileWrites Include="$(JavaClassOutputPath)\**\*" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <BuildJavaClassesDependsOn>
            ResolveJavaSourceItems;
            ResolveJavaClasspath;
            _BuildJavaClasses;
            $(BuildJavaClassesDependsOn)
        </BuildJavaClassesDependsOn>
    </PropertyGroup>

    <Target Name="BuildJavaClasses" DependsOnTargets="$(BuildJavaClassesDependsOn)">

    </Target>

    <Target Name="BuildRmiStubs" DependsOnTargets="BuildJavaClasses" Inputs="$(JavaClassOutputPath)\stamp" Outputs="$(RmiStubsOutputPath)\stamp">
        <Delete Files="$(RmiStubsOutputPath)\**\*" />
        <RemoveDir Directories="$(RmiStubsOutputPath)" />
        <MakeDir Directories="$(RmiStubsOutputPath)" />

        <PropertyGroup>
            <RmiVmArgs>-J-client -J-Xmx896m -J-Xms128m</RmiVmArgs>
            <RmiArgs>$(RmiVmArgs) -nowarn -bootclasspath @(JavaClasspath);$(JavaClassOutputPath) -d $(RmiStubsOutputPath)</RmiArgs>
        </PropertyGroup>

        <Exec Command="rmic $(RmiArgs) -v1.1 sun.rmi.registry.RegistryImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.1 sun.rmi.transport.DGCImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 sun.rmi.server.Activation$ActivationSystemImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 java.rmi.activation.ActivationGroup" />
        <Exec Command="rmic $(RmiArgs) -v1.2 com.sun.jndi.rmi.registry.ReferenceWrapper" />
        <Exec Command="rmic $(RmiArgs) -v1.2 javax.management.remote.rmi.RMIConnectionImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 -iiop javax.management.remote.rmi.RMIConnectionImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 -iiop -standardPackage javax.management.remote.rmi.RMIConnectionImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 javax.management.remote.rmi.RMIServerImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 -iiop javax.management.remote.rmi.RMIServerImpl" />
        <Exec Command="rmic $(RmiArgs) -v1.2 -iiop -standardPackage javax.management.remote.rmi.RMIServerImpl" />
        <Exec Command="rmic $(RmiArgs) -iiop javax.management.remote.rmi.RMIConnection" />
        <Exec Command="rmic $(RmiArgs) -iiop -standardPackage javax.management.remote.rmi.RMIConnection" />
        <Exec Command="rmic $(RmiArgs) -iiop javax.management.remote.rmi.RMIServer" />
        <Exec Command="rmic $(RmiArgs) -iiop -standardPackage javax.management.remote.rmi.RMIServer" />
        <Touch Files="$(RmiStubsOutputPath)\stamp" AlwaysCreate="true" ForceTouch="true" />

        <ItemGroup>
            <FileWrites Include="$(RmiStubsOutputPath)\**\*" />
        </ItemGroup>
    </Target>

    <Target Name="GetIkvmcExe" DependsOnTargets="ResolveProjectReferences">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\ikvmc\ikvmc.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="_Ikvmc" />
        </MSBuild>
        <PropertyGroup>
            <Ikvmc>@(_Ikvmc)</Ikvmc>
        </PropertyGroup>
    </Target>

    <Target Name="GetIkvmRuntimeDll" DependsOnTargets="ResolveProjectReferences">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\IKVM.Runtime-ref\IKVM.Runtime-ref.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="_IkvmRuntimeDll" />
        </MSBuild>
        <PropertyGroup>
            <IkvmRuntimeDll>@(_IkvmRuntimeDll)</IkvmRuntimeDll>
        </PropertyGroup>
    </Target>

    <Target Name="ResolveJavaClassItems" DependsOnTargets="BuildJavaClasses;BuildRmiStubs">
        <ItemGroup>
            <JavaClassItems Include="$(JavaClassOutputPath)\**\*.class" />
            <JavaClassItems Include="$(RmiStubsOutputPath)\**\*.class" />
        </ItemGroup>
    </Target>

    <Target Name="_BuildOpenJdkAssembly" DependsOnTargets="GetIkvmcExe;GetIkvmRuntimeDll;ResolveJavaClassItems;ResolveJavaResourceItems;BuildResourcesZip;BuildRmiStubs">
        <Message Text="JavaClassItems: @(JavaClassItems)" Importance="high" />
        <Message Text="JavaResourceItems: @(JavaResourceItems->'%(Identity)=&gt;%(ResourcePath)')" Importance="high" />

        <!-- this is wrong, determination of which version to use to build needs to be based on which platform we're running on -->
        <PropertyGroup Condition="$(TargetFramework.StartsWith('net4'))">
            <IkvmcExec>$(Ikvmc)</IkvmcExec>
        </PropertyGroup>
        <PropertyGroup Condition="$(TargetFramework.StartsWith('netstandard')) Or $(TargetFramework.StartsWith('netcore'))">
            <IkvmcExec>dotnet exec $(Ikvmc)</IkvmcExec>
        </PropertyGroup>

        <Delete Files="$(IntermediateOutputPath)ikvmc.exclude.txt" />
        <WriteLinesToFile File="$(IntermediateOutputPath)ikvmc.exclude.txt" Lines="@(OpenJdkExcludeRegex)" />

        <ItemGroup>
            <JavaResourceItemsWithJavaSep Include="@(JavaResourceItems)" ResourcePath="$([System.String]::Copy(%(ResourcePath)).Replace('\', '/'))" />
            <IkvmcArgs Include="-runtime:$(IkvmRuntimeDll)" />
            <IkvmcArgs Include="-remap:map.xml" />
            <IkvmcArgs Include="-exclude:$(IntermediateOutputPath)ikvmc.exclude.txt" />
            <IkvmcArgs Include="@(_ResolveAssemblyReferenceResolvedFiles->'-reference:%(Identity)')" />
            <IkvmcArgs Include="@(JavaResourceItemsWithJavaSep->'-resource:%(ResourcePath)=%(Identity)')" />
            <!--<IkvmcArgs Include="-recurse:$(ResourcesZipPath.Replace('\', '/'))/*" />-->
            <IkvmcArgs Include="@(JavaClassItems)" />
        </ItemGroup>

        <Delete Files="$(IntermediateOutputPath)ikvmc.args.txt" />
        <WriteLinesToFile File="$(IntermediateOutputPath)ikvmc.args.txt" Lines="@(IkvmcArgs)" />

        <Message Text="$(IkvmcExec) -assembly:openjdk -version:0.0.0.0 -compressresources -opt:fields -strictfinalfieldsemantics -removeassertions -target:library -sharedclassloader -nowarn:110 -w4 -noparameterreflection -out:$(OpenJdkAssemblyPath) @$(IntermediateOutputPath)ikvmc.args.txt" Importance="high" />
        <Exec Command="$(IkvmcExec) -assembly:openjdk -version:0.0.0.0 -compressresources -opt:fields -strictfinalfieldsemantics -removeassertions -target:library -sharedclassloader -nowarn:110 -w4 -noparameterreflection -out:$(OpenJdkAssemblyPath) @$(IntermediateOutputPath)ikvmc.args.txt" />

        <ItemGroup>
            <FileWrites Include="$(IntermediateOutputPath)ikvmc.args.txt" />
            <FileWrites Include="$(IntermediateOutputPath)ikvmc.exclude.txt" />
            <FileWrites Include="$(OpenJdkAssemblyPath)" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <BuildOpenJdkAssemblyDependsOn>
            GetIkvmcExe;
            GetIkvmRuntimeDll;
            ResolveJavaClassItems;
            ResolveJavaResourceItems;
            BuildResourcesZip;
            BuildRmiStubs;
            _BuildOpenJdkAssembly;
            $(BuildOpenJdkAssemblyDependsOn);
        </BuildOpenJdkAssemblyDependsOn>
    </PropertyGroup>

    <Target Name="BuildOpenJdkAssembly" DependsOnTargets="$(BuildOpenJdkAssemblyDependsOn)">

    </Target>

</Project>
