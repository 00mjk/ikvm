<Project>
    <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />

    <PropertyGroup>
        <TargetFrameworks>net461;netcoreapp3.1</TargetFrameworks>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    </PropertyGroup>

    <PropertyGroup>
        <OpenJdkDir>..\..\..\openjdk-8u45-b14</OpenJdkDir>
        <OpenJdkImplementationVersion>1.8.0</OpenJdkImplementationVersion>
        <OpenJdkSpecificationVersion>1.8</OpenJdkSpecificationVersion>
        <OpenJdkFullVersion>1.8.0_45-b14</OpenJdkFullVersion>
        <OpenJdkVersion>OpenJDK 8u45 b14</OpenJdkVersion>
    </PropertyGroup>

    <PropertyGroup Label="NuGet Package/Assembly Settings">
        <RootNamespace>openjdk</RootNamespace>
        <AssemblyName>openjdk</AssemblyName>
        <AssemblyTitle>IKVM.NET Compiler</AssemblyTitle>
        <Description>JVM for Mono and .NET</Description>
    </PropertyGroup>

    <ItemGroup>
        <ProjectReference Include="..\IKVM.Runtime-ref\IKVM.Runtime-ref.csproj" />
        <ProjectReference Include="..\ikvmc\ikvmc.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
        <ProjectReference Include="..\ikvmstub\ikvmstub.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="System.CodeDom" Version="6.0.0" />
        <PackageReference Include="System.Data.OleDb" Version="6.0.0" />
        <PackageReference Include="System.Data.SqlClient" Version="4.8.3" />
        <PackageReference Include="System.Diagnostics.PerformanceCounter" Version="6.0.1" />
        <PackageReference Include="System.IO.Packaging" Version="6.0.0" />
        <PackageReference Include="System.IO.Pipes" Version="4.3.0" />
        <PackageReference Include="System.IO.Pipes.AccessControl" Version="5.0.0" />
        <PackageReference Include="System.IO.Ports" Version="6.0.0" />
        <PackageReference Include="System.Security.Cryptography.Xml" Version="6.0.0" />
        <PackageReference Include="System.Security.Permissions" Version="6.0.0" />
        <PackageReference Include="System.Configuration.ConfigurationManager" Version="6.0.0" />
        <PackageReference Include="System.Drawing.Primitives " Version="4.3.0" />
        <PackageReference Include="System.Drawing.Common" Version="6.0.0" />
        <PackageReference Include="System.IO.FileSystem.AccessControl" Version="5.0.0" />
        <PackageReference Include="System.Security.AccessControl" Version="6.0.0" />
        <PackageReference Include="System.Security.Principal.Windows" Version="5.0.0" />
        <PackageReference Include="System.Security.Cryptography.Cng" Version="5.0.0" />
        <PackageReference Include="System.ServiceModel.Syndication" Version="6.0.0" />
        <PackageReference Include="System.ServiceProcess.ServiceController" Version="6.0.0" />
        <PackageReference Include="System.Threading.AccessControl" Version="6.0.0" />
        <PackageReference Include="System.Data.Odbc" Version="6.0.0" />
        <PackageReference Include="Newtonsoft.Json" Version="12.0.3" />
    </ItemGroup>

    <ItemDefinitionGroup>
        <StubAssembly>
            <Args></Args>
        </StubAssembly>
    </ItemDefinitionGroup>

    <ItemGroup>
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\calendars.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\logging.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\net.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\psfontj2d.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\sound.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\tzdb.dat" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\currency.data" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\management\management.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\cmm\*" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\security\java.policy" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\security\java.security" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\**\lib\security\US_export_policy.jar" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\jdk\src\windows\**\lib\flavormap.properties" />
        <VfsZipIncludeFile Include="$(OpenJdkDir)\jdk\src\windows\**\lib\content-types.properties" />
    </ItemGroup>

    <ItemGroup>
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\com\sun\corba\se\impl\orbutil\resources\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\com\sun\rowset\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\javax\swing\text\html\parser\html32.bdtd" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\rmi\registry\resources\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\rmi\server\resources\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\text\resources\*IteratorData" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\text\resources\th\*IteratorData_th" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\classes\**\sun\text\resources\th\thai_dict" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\corba\src\share\classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.gif" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.png" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\*.wav" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\com\sun\org\apache\xml\internal\security\resource\config.*" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\com\sun\swing\internal\plaf\**\*" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\javax\swing\text\html\default.css" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\javax\swing\text\rtf\charsets\*.txt" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jdk\src\share\classes\**\sun\text\resources\**\*.icu" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxp\src\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxp\src\**\*.res" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxws\src\share\jaf_classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxws\src\share\jaxws_classes\**\*.properties" />
        <ResourcesZipIncludeFile Include="$(OpenJdkDir)\jaxws\src\share\jaxws_classes\**\*.xml" />
    </ItemGroup>

    <ItemGroup>
        <JavaSource Include="source\**\*.java" />
        <JavaSource Update="source\**\*.netcoreapp3_1.java" TargetFramework="netcoreapp3.1" />
        <JavaSource Update="source\**\*.net461.java" TargetFramework="net461" />
        <JavaSourceTemplate Include="source\**\*.java.in" />
    </ItemGroup>

    <ItemGroup>
        <JavaResource Include="resources\**\*" ResourcePath="%(RecursiveDir)%(Filename)%(Extension)" />
        <JavaResource Update="resources\**\*.netcoreapp3_1" ResourcePath="%(RecursiveDir)%(Filename)%(Extension)" TargetFramework="netcoreapp3.1" />
        <JavaResource Update="resources\**\*.net461" ResourcePath="%(RecursiveDir)%(Filename)" TargetFramework="net461" />
        <JavaResourceTemplate Include="resources\**\*.in" ResourcePath="%(RecursiveDir)%(Filename)" />
    </ItemGroup>

    <ItemGroup>
        <OpenJdkClasspath Include="$(OpenJdkDir)\jdk\src\share\classes" />
        <OpenJdkClasspath Include="$(OpenJdkDir)\corba\src\share\classes" />
        <OpenJdkClasspath Include="$(OpenJdkDir)\build\linux-x86_64-normal-server-release\jdk\gensrc" />
    </ItemGroup>

    <Import Project="openjdk.props" />

    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />

    <UsingTask TaskName="TransformTemplate" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Using Namespace="System.Text.RegularExpressions" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                foreach (var i in Items)
                {
                    var fullPath = i.GetMetadata("FullPath");
                    var destPath = i.GetMetadata("Destination");
                    Directory.CreateDirectory(Path.GetDirectoryName(destPath));
                    File.Copy(fullPath, destPath, true);
                }
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <UsingTask TaskName="DistinctSourceItems" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Source ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
            <Output ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                var hs = new Dictionary<string, ITaskItem>();
                foreach (var i in Source)
                    hs[i.GetMetadata("Key")] = i;
                Output = hs.Values.ToArray();
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <PropertyGroup>
        <JavaSourceTemplateOutputPath>$(IntermediateOutputPath)sources</JavaSourceTemplateOutputPath>
        <JavaResourceTemplateOutputPath>$(IntermediateOutputPath)resources</JavaResourceTemplateOutputPath>
        <StubOutputPath>$(IntermediateOutputPath)stubs</StubOutputPath>
        <VfsZipTempPath>$(IntermediateOutputPath)vfs_zip</VfsZipTempPath>
        <VfsZipPath>$(IntermediateOutputPath)vfs.zip</VfsZipPath>
        <ResourcesZipTempPath>$(IntermediateOutputPath)resources_zip</ResourcesZipTempPath>
        <ResourceZipPath>$(IntermediateOutputPath)resources.zip</ResourceZipPath>
        <OpenJdkClassDir>$(IntermediateOutputPath)classes</OpenJdkClassDir>
    </PropertyGroup>

    <PropertyGroup>
        <BuildDependsOn>
            BuildOpenJdkAssembly;
            $(BuildDependsOn);
        </BuildDependsOn>
    </PropertyGroup>

    <UsingTask TaskName="TransformTemplate" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Using Namespace="System.Text.RegularExpressions" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                foreach (var i in Items)
                {
                    var fullPath = i.GetMetadata("FullPath");
                    var destPath = i.GetMetadata("Destination");
                    Directory.CreateDirectory(Path.GetDirectoryName(destPath));
                    File.Copy(fullPath, destPath, true);
                }
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <UsingTask TaskName="DistinctSourceItems" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <Source ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
            <Output ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                var hs = new Dictionary<string, ITaskItem>();
                foreach (var i in Source)
                    hs[i.GetMetadata("Key")] = i;
                Output = hs.Values.ToArray();
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <Target Name="GetIkvmStubExe" DependsOnTargets="ResolveReferences">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\ikvmstub\ikvmstub.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="_IkvmStub" />
        </MSBuild>
        <PropertyGroup>
            <IkvmStub>@(_IkvmStub)</IkvmStub>
        </PropertyGroup>
    </Target>

    <Target Name="ResolveIkvmRuntimeAssembly">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\IKVM.Runtime-ref\IKVM.Runtime-ref.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="StubAssembly" />
        </MSBuild>
    </Target>

    <Target Name="ResolveStubs" DependsOnTargets="ResolveIkvmRuntimeAssembly;ResolveProjectReferences;ResolveAssemblyReferences">
        <PropertyGroup>
            <_StubArgs>@(_ResolveAssemblyReferenceResolvedFiles->'-r:"%(Identity)"', ' ')</_StubArgs>
        </PropertyGroup>
        <ItemGroup>
            <_StubAssembly Include="@(_ResolveAssemblyReferenceResolvedFiles)">
                <JarPath>$(StubOutputPath)\%(Filename).jar</JarPath>
                <Args>$(_StubArgs)</Args>
            </_StubAssembly>
        </ItemGroup>
    </Target>

    <Target Name="BuildStubs" DependsOnTargets="ResolveStubs;GetIkvmStubExe" Inputs="@(_StubAssembly)" Outputs="%(JarPath)">
        <MakeDir Directories="$(StubOutputPath)" />

        <!-- this is wrong, determination of which version to use to build needs to be based on which platform we're running on -->
        <PropertyGroup Condition="$(TargetFramework.StartsWith('net4'))">
            <IkvmStubExec>$(IkvmStub)</IkvmStubExec>
        </PropertyGroup>
        <PropertyGroup Condition="$(TargetFramework.StartsWith('netstandard')) Or $(TargetFramework.StartsWith('netcore'))">
            <IkvmStubExec>dotnet exec $(IkvmStub)</IkvmStubExec>
        </PropertyGroup>

        <Message Text="$(IkvmStubExec) -forwarders -bootstrap &quot;@(_StubAssembly)&quot; %(Args) -out:%(JarPath)" Condition=" '%(Identity)' != '' " Importance="high" />
        <Exec Command="$(IkvmStubExec) -forwarders -bootstrap &quot;@(_StubAssembly)&quot; %(Args) -out:%(JarPath)" Condition=" '%(Identity)' != '' " />

        <ItemGroup>
            <StubJar Include="@(_StubAssembly->'%(JarPath)')" />
            <FileWrites Include="@(_StubAssembly->'%(JarPath)')" />
        </ItemGroup>
    </Target>

    <Target Name="BuildVfsZip" Inputs="@(VfsZipIncludeFile)" Outputs="$(VfsZipPath)">
        <Delete Files="$(VfsZipTempPath)\**\*" />
        <RemoveDir Directories="$(VfsZipTempPath)" />
        <MakeDir Directories="$(VfsZipTempPath)" />
        <Copy SourceFiles="@(VfsZipIncludeFile)" DestinationFolder="$(VfsZipTempPath)\%(RecursiveDir)" />
        <Delete Files="$(VfsZipPath)" />
        <ZipDirectory SourceDirectory="$(VfsZipTempPath)" DestinationFile="$(VfsZipPath)" />
        <ItemGroup>
            <FileWrites Include="$(VfsZipTempPath)\**\*" />
            <FileWrites Include="$(VfsZipPath)" />
        </ItemGroup>
    </Target>

    <Target Name="BuildResourcesZip" Inputs="@(ResourcesZipIncludeFile)" Outputs="$(ResourceZipPath)">
        <Delete Files="$(ResourcesZipTempPath)\**\*" />
        <RemoveDir Directories="$(ResourcesZipTempPath)" />
        <MakeDir Directories="$(ResourcesZipTempPath)" />
        <Copy SourceFiles="@(ResourcesZipIncludeFile)" DestinationFolder="$(ResourcesZipTempPath)\%(RecursiveDir)" />
        <Delete Files="$(ResourceZipPath)" />
        <ZipDirectory SourceDirectory="$(ResourcesZipTempPath)" DestinationFile="$(ResourceZipPath)" />
        <ItemGroup>
            <FileWrites Include="$(ResourcesZipTempPath)\**\*" />
            <FileWrites Include="$(ResourceZipPath)" />
        </ItemGroup>
    </Target>

    <Target Name="ResolveTransformJavaSourceTemplates">
        <ItemGroup>
            <TransformJavaSourceTemplate Include="@(JavaSourceTemplate)">
                <Destination>$(JavaSourceTemplateOutputPath)\%(RecursiveDir)%(Filename)</Destination>
            </TransformJavaSourceTemplate>
        </ItemGroup>
    </Target>

    <Target Name="TransformJavaSourceTemplates" DependsOnTargets="ResolveTransformJavaSourceTemplates" Inputs="@(TransformJavaSourceTemplate)" Outputs="@(TransformJavaSourceTemplate->'%(Destination)')">
        <Delete Files="$(JavaSourceTemplateOutputPath)\**\*" />
        <RemoveDir Directories="$(JavaSourceTemplateOutputPath)" />
        <MakeDir Directories="$(JavaSourceTemplateOutputPath)" />
        <TransformTemplate Items="@(TransformJavaSourceTemplate)" />
        <ItemGroup>
            <JavaSourceTemplateItem Include="@(TransformJavaSourceTemplate->'%(Destination)')" />
            <FileWrites Include="@(TransformJavaSourceTemplate->'%(Destination)')" />
        </ItemGroup>
    </Target>

    <Target Name="ResolveOpenJdkSourceItems" DependsOnTargets="TransformJavaSourceTemplates">
        <ItemGroup>
            <_OpenJdkSourceItems Include="@(OpenJdkCompile)" Condition=" '%(Extension)' == '.java' ">
                <Key>%(Identity)</Key>
            </_OpenJdkSourceItems>
            <_OpenJdkSourceItems Include="@(JavaSource)" Condition=" '%(JavaSource.TargetFramework)' == '' Or '%(JavaSource.TargetFramework)' == '$(TargetFramework)' ">
                <Key>%(RecursiveDir)%(Filename)%(Extension)</Key>
            </_OpenJdkSourceItems>
            <_OpenJdkSourceItems Include="@(JavaSourceTemplateItem)">
                <Key>%(RecursiveDir)%(Filename)%(Extension)</Key>
            </_OpenJdkSourceItems>
        </ItemGroup>
        <DistinctSourceItems Source="@(_OpenJdkSourceItems)">
            <Output TaskParameter="Output" ItemName="_OpenJdkSourceItemsDistinct" />
        </DistinctSourceItems>
        <ItemGroup>
            <OpenJdkSourceItems Include="@(_OpenJdkSourceItemsDistinct)" />
        </ItemGroup>
    </Target>

    <Target Name="ResolveJavaClasspath" DependsOnTargets="BuildStubs">
        <ItemGroup>
            <JavaClasspath Include="@(StubJar)" />
            <JavaClasspath Include="@(OpenJdkClasspath)" />
        </ItemGroup>
    </Target>

    <Target Name="BuildOpenJdkClasses" DependsOnTargets="ResolveOpenJdkSourceItems;ResolveJavaClasspath" Inputs="@(OpenJdkSourceItems)" Outputs="$(IntermediateOutputPath)sources.list">
        <Delete Files="$(IntermediateOutputPath)sources.list" />
        <WriteLinesToFile File="$(IntermediateOutputPath)sources.list" Lines="@(OpenJdkSourceItems)" />
        <Delete Files="$(OpenJdkClassDir)\**\*" />
        <RemoveDir Directories="$(OpenJdkClassDir)" />
        <MakeDir Directories="$(OpenJdkClassDir)" />
        <Message Text="javac -J-Xmx1536M -g -nowarn -implicit:none -parameters -cp dummy -bootclasspath @(JavaClasspath) -d $(OpenJdkClassDir) @$(IntermediateOutputPath)sources.list" Importance="high" />
        <Exec Command="javac -J-Xmx1536M -g -nowarn -implicit:none -parameters -cp dummy -bootclasspath @(JavaClasspath) -d $(OpenJdkClassDir) @$(IntermediateOutputPath)sources.list" />
        <ItemGroup>
            <FileWrites Include="$(IntermediateOutputPath)sources.list" />
            <FileWrites Include="$(OpenJdkClassDir)\**\*" />
        </ItemGroup>
    </Target>

    <Target Name="ResolveTransformJavaResourceTemplates">
        <ItemGroup>
            <TransformJavaResourceTemplate Include="@(JavaResourceTemplate)">
                <Destination>$(JavaResourceTemplateOutputPath)\%(RecursiveDir)%(Filename)</Destination>
            </TransformJavaResourceTemplate>
        </ItemGroup>
    </Target>

    <Target Name="TransformJavaResourceTemplates" DependsOnTargets="ResolveTransformJavaResourceTemplates" Inputs="@(TransformJavaResourceTemplate)" Outputs="@(TransformJavaResourceTemplate->'%(Destination)')">
        <Delete Files="$(JavaResourceTemplateOutputPath)\**\*" />
        <RemoveDir Directories="$(JavaResourceTemplateOutputPath)" />
        <MakeDir Directories="$(JavaResourceTemplateOutputPath)" />
        <TransformTemplate Items="@(TransformJavaResourceTemplate)" />
        <ItemGroup>
            <JavaResourceTemplateItem Include="@(TransformJavaResourceTemplate->'%(Destination)')" Path="%(TransformJavaResourceTemplate.Path)" />
            <FileWrites Include="@(TransformJavaResourceTemplate->'%(Destination)')" />
        </ItemGroup>
    </Target>

    <Target Name="ResolveOpenJdkResourceItems" DependsOnTargets="TransformJavaResourceTemplates">
        <ItemGroup>
            <_OpenJdkResourceItems Include="@(OpenJdkResource)">
                <Key>%(ResourcePath)</Key>
            </_OpenJdkResourceItems>
            <_OpenJdkResourceItems Include="@(JavaResource)" Condition=" '%(JavaSource.TargetFramework)' == '' Or '%(JavaSource.TargetFramework)' == '$(TargetFramework)' ">
                <Key>%(RecursiveDir)%(Filename)%(Extension)</Key>
            </_OpenJdkResourceItems>
            <_OpenJdkResourceItems Include="@(JavaResourceTemplateItem)">
                <Key>%(RecursiveDir)%(Filename)%(Extension)</Key>
            </_OpenJdkResourceItems>
        </ItemGroup>
        <DistinctSourceItems Source="@(_OpenJdkResourceItems)">
            <Output TaskParameter="Output" ItemName="_OpenJdkResourceItemsDistinct" />
        </DistinctSourceItems>
        <ItemGroup>
            <OpenJdkResourceItems Include="@(_OpenJdkResourceItemsDistinct)" />
        </ItemGroup>
    </Target>

    <Target Name="GetIkvmcExe" DependsOnTargets="ResolveReferences">
        <MSBuild Projects="@(_MSBuildProjectReferenceExistent)" Targets="GetTargetPath" BuildInParallel="$(BuildInParallel)" Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);%(_MSBuildProjectReferenceExistent.SetPlatform);%(_MSBuildProjectReferenceExistent.SetTargetFramework)" RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)$(_GlobalPropertiesToRemoveFromProjectReferences)" Condition=" '%(_MSBuildProjectReferenceExistent.Identity)' == '..\ikvmc\ikvmc.csproj' ">
            <Output TaskParameter="TargetOutputs" ItemName="_Ikvmc" />
        </MSBuild>
        <PropertyGroup>
            <Ikvmc>@(Ikvmc)</Ikvmc>
        </PropertyGroup>
    </Target>
    
    <Target Name="ResolveOpenJdkClassItems" DependsOnTargets="BuildOpenJdkClasses">
        <ItemGroup>
            <OpenJdkClassItems Include="$(OpenJdkClassDir)\**\*.class" />
        </ItemGroup>
    </Target>

    <Target Name="BuildOpenJdkAssembly" DependsOnTargets="GetIkvmcExe;ResolveOpenJdkClassItems;ResolveOpenJdkResourceItems">
        <Message Text="OpenJdkClassItems: @(OpenJdkClassItems)" Importance="high" />
        <Message Text="OpenJdkResourceItems: @(OpenJdkResourceItems->'%(Identity)=&gt;%(ResourcePath)')" Importance="high" />
    </Target>

</Project>
